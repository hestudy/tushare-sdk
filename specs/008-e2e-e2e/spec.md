# Feature Specification: 文档站E2E测试重构

**Feature Branch**: `008-e2e-e2e`
**Created**: 2025-10-13
**Status**: Draft
**Input**: User description: "文档站已经全面完善，现有e2e测试已经过时，需要重构现有的e2e测试，匹配全新的文档站"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 验证文档站核心页面可访问性 (Priority: P1)

开发者运行E2E测试套件，验证所有核心文档页面（首页、指南页、API文档页、更新日志页）能够正常访问并显示预期内容，确保文档站基础功能正常。

**Why this priority**: 这是最基础的功能验证，任何页面无法访问都会导致用户无法使用文档站。这是文档站价值交付的前提条件。

**Independent Test**: 可以独立运行页面访问测试，无需依赖其他功能。测试访问每个页面URL并验证关键元素（标题、核心内容）是否正确渲染。

**Acceptance Scenarios**:

1. **Given** 文档站开发服务器运行在 localhost:3000, **When** 测试访问首页 `/`, **Then** 页面成功加载且显示标题 "Tushare SDK"
2. **Given** 文档站正常运行, **When** 测试访问快速入门指南 `/guide/quick-start`, **Then** 页面显示快速入门内容和代码示例
3. **Given** 文档站正常运行, **When** 测试访问安装指南 `/guide/installation`, **Then** 页面显示安装命令和包名 `@hestudy/tushare-sdk`
4. **Given** 文档站正常运行, **When** 测试访问配置指南 `/guide/configuration`, **Then** 页面显示配置相关内容和 Token 配置方法
5. **Given** 文档站正常运行, **When** 测试访问错误处理指南 `/guide/error-handling`, **Then** 页面显示错误处理相关内容
6. **Given** 文档站正常运行, **When** 测试访问股票基础信息API `/api/stock/basic`, **Then** 页面显示API名称、参数说明和代码示例
7. **Given** 文档站正常运行, **When** 测试访问日线数据API `/api/stock/daily`, **Then** 页面显示完整的API文档
8. **Given** 文档站正常运行, **When** 测试访问交易日历API `/api/calendar`, **Then** 页面显示API文档内容
9. **Given** 文档站正常运行, **When** 测试访问每日指标API `/api/daily-basic`, **Then** 页面显示API文档内容
10. **Given** 文档站正常运行, **When** 测试访问更新日志页 `/changelog/`, **Then** 页面显示标题 "更新日志" 和版本信息

---

### User Story 2 - 验证导航栏和侧边栏功能 (Priority: P1)

开发者运行E2E测试，验证顶部导航栏的所有链接（指南、API文档、更新日志、GitHub）可以正常跳转，以及侧边栏的分类目录正确显示且链接可点击跳转，确保用户能够顺利浏览文档。

**Why this priority**: 导航是用户浏览文档的核心交互方式，导航失效会严重影响用户体验，使用户无法找到所需文档。

**Independent Test**: 可以独立测试导航功能，测试点击导航链接并验证URL变化和页面内容，无需依赖其他功能。

**Acceptance Scenarios**:

1. **Given** 用户在首页, **When** 点击顶部导航栏的 "指南" 链接, **Then** 跳转到指南页面且URL包含 `/guide/`
2. **Given** 用户在首页, **When** 点击顶部导航栏的 "API 文档" 链接, **Then** 跳转到API文档页面且URL包含 `/api/`
3. **Given** 用户在首页, **When** 点击顶部导航栏的 "更新日志" 链接, **Then** 跳转到更新日志页面且URL包含 `/changelog/`
4. **Given** 用户在API文档页, **When** 查看侧边栏, **Then** 显示 "股票数据" 和 "交易相关" 分类
5. **Given** 用户在 `/api/stock/basic` 页面, **When** 点击侧边栏中的 "日线数据" 链接, **Then** 跳转到 `/api/stock/daily` 页面
6. **Given** 用户在 `/api/stock/basic` 页面, **When** 点击侧边栏中的 "交易日历" 链接, **Then** 跳转到 `/api/calendar` 页面
7. **Given** 用户在指南页, **When** 查看侧边栏, **Then** 显示 "安装"、"快速开始"、"配置" 和 "错误处理" 链接
8. **Given** 用户在 `/guide/installation` 页面, **When** 点击侧边栏中的 "快速开始" 链接, **Then** 跳转到 `/guide/quick-start` 页面

---

### User Story 3 - 验证代码示例功能 (Priority: P2)

开发者运行E2E测试，验证所有文档页面中的代码示例正确显示、支持语法高亮、显示行号，以及复制按钮能够正常工作，确保用户可以方便地查看和复制代码。

**Why this priority**: 代码示例是技术文档的核心价值，但相比页面访问和导航，代码复制功能的失效不会完全阻止用户使用文档（用户仍可手动复制）。

**Independent Test**: 可以独立测试代码块功能，访问包含代码示例的页面，验证代码块渲染、复制按钮存在和复制功能是否正常。

**Acceptance Scenarios**:

1. **Given** 用户访问 `/guide/quick-start` 页面, **When** 查看页面内容, **Then** 至少显示一个代码块且包含 TypeScript 代码
2. **Given** 用户访问 `/api/stock/basic` 页面, **When** 查看代码示例, **Then** 代码块显示语法高亮和行号
3. **Given** 用户在包含代码块的页面, **When** 鼠标悬停在代码块上, **Then** 显示复制按钮
4. **Given** 用户看到代码块的复制按钮, **When** 点击复制按钮, **Then** 代码内容成功复制到剪贴板
5. **Given** 用户成功复制代码, **When** 读取剪贴板内容, **Then** 内容长度大于0且包含代码文本
6. **Given** 用户访问 `/guide/quick-start`, **When** 检查代码示例, **Then** 代码块包含 `import` 语句和 `TushareClient` 相关代码
7. **Given** 用户访问 `/api/stock/basic`, **When** 检查代码示例, **Then** 代码块包含函数调用示例和参数使用说明

---

### User Story 4 - 验证更新日志页面结构和内容 (Priority: P2)

开发者运行E2E测试，验证更新日志页面的结构清晰、版本按倒序排列、包含版本号和发布日期、更新内容有明确分类（新增功能、Bug修复等），确保用户能够快速了解版本变更。

**Why this priority**: 更新日志对于了解版本变化很重要，但不是核心使用文档。用户主要使用指南和API文档，更新日志的问题不会严重影响主要使用场景。

**Independent Test**: 可以独立测试更新日志页面，访问 `/changelog/` 并验证页面结构、版本号格式、日期格式和内容分类，无需依赖其他页面。

**Acceptance Scenarios**:

1. **Given** 用户访问 `/changelog/` 页面, **When** 查看页面结构, **Then** 页面包含主标题(h1)和至少一个版本标题(h2)
2. **Given** 用户在更新日志页面, **When** 查看版本号, **Then** 版本号符合 `vX.Y.Z` 或 `X.Y.Z` 格式
3. **Given** 用户在更新日志页面, **When** 查看发布日期, **Then** 日期格式为 `YYYY-MM-DD`、`YYYY/MM/DD` 或 `YYYY.MM.DD`
4. **Given** 用户在更新日志页面, **When** 查看更新内容, **Then** 包含分类关键词（新增/功能/Features 或 修复/Bug/Fixes）
5. **Given** 更新日志包含破坏性变更, **When** 查看相关内容, **Then** 包含迁移指南或升级注意事项的说明

---

### User Story 5 - 验证响应式设计在移动设备上的表现 (Priority: P3)

开发者运行E2E测试，验证文档站在移动设备（手机、平板）上的布局正确、侧边栏折叠和展开正常、代码块支持横向滚动、导航栏正常显示，确保移动端用户能够正常浏览文档。

**Why this priority**: 响应式设计对移动用户很重要，但大部分开发者主要在桌面端查看技术文档。移动端问题不会影响主要用户群的使用。

**Independent Test**: 可以独立测试响应式设计，设置不同的视口尺寸（手机、平板）并验证布局和交互，无需依赖其他功能。

**Acceptance Scenarios**:

1. **Given** 测试设置移动端视口（390x844，模拟 iPhone 12 Pro）, **When** 访问 `/api/stock/basic` 页面, **Then** 侧边栏默认不可见或折叠
2. **Given** 移动端侧边栏折叠, **When** 点击菜单按钮, **Then** 侧边栏展开并可见
3. **Given** 移动端视口（375x667）, **When** 访问包含代码块的页面, **Then** 代码块支持横向滚动且不破坏页面布局
4. **Given** 移动端视口（375x667）, **When** 访问首页, **Then** 导航栏正常显示且高度小于100px
5. **Given** 平板视口（768x1024，模拟 iPad）, **When** 访问 `/api/stock/basic` 页面, **Then** 侧边栏可见或可以通过菜单按钮展开
6. **Given** 移动端视口, **When** 页面包含图片, **Then** 图片宽度不超过视口宽度且正确缩放

---

### Edge Cases

- 当用户访问不存在的页面路径（如 `/api/non-existent`）时，如何处理？应该显示404页面
- 当网络缓慢导致页面加载超时时，测试如何处理？应该设置合理的超时时间（如2分钟）
- 当浏览器禁用JavaScript时，文档站是否仍能显示静态内容？rspress生成静态HTML应该支持
- 当用户浏览器不支持clipboard API时，复制按钮如何表现？应该优雅降级或隐藏复制功能
- 当代码块内容非常长（超过屏幕高度）时，是否支持垂直滚动？应该支持
- 当侧边栏分类层级很深时，是否正确展开和折叠？rspress应该自动处理
- 当移动端横屏显示时，布局是否仍然正常？应该支持横屏模式
- 当快速连续点击导航链接时，路由是否正常工作？不应该出现路由错误
- 当API文档缺少某些部分（如代码示例）时，测试是否会失败？测试应该检查必需内容，可选内容不应导致失败

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: E2E测试套件必须验证文档站所有核心页面（首页、4个指南页、4个API文档页、更新日志页）能够成功加载
- **FR-002**: E2E测试套件必须验证每个页面的主标题（h1）正确显示且内容符合预期
- **FR-003**: E2E测试套件必须验证顶部导航栏的所有链接（指南、API文档、更新日志）能够正常跳转到对应页面
- **FR-004**: E2E测试套件必须验证侧边栏在API文档页显示正确的分类结构（股票数据、交易相关）
- **FR-005**: E2E测试套件必须验证侧边栏在指南页显示正确的导航链接（安装、快速开始、配置、错误处理）
- **FR-006**: E2E测试套件必须验证侧边栏链接点击后能够正确跳转到对应页面
- **FR-007**: E2E测试套件必须验证所有包含代码示例的页面至少显示一个代码块
- **FR-008**: E2E测试套件必须验证代码块显示复制按钮
- **FR-009**: E2E测试套件必须验证点击复制按钮后代码内容成功复制到剪贴板
- **FR-010**: E2E测试套件必须验证更新日志页面显示清晰的标题结构（h1主标题和h2版本标题）
- **FR-011**: E2E测试套件必须验证更新日志页面包含符合语义化版本规范的版本号
- **FR-012**: E2E测试套件必须验证更新日志页面包含日期信息
- **FR-013**: E2E测试套件必须验证更新日志页面的更新内容包含分类说明
- **FR-014**: E2E测试套件必须验证移动端视口（390x844）下侧边栏默认折叠或隐藏
- **FR-015**: E2E测试套件必须验证移动端点击菜单按钮后侧边栏能够展开
- **FR-016**: E2E测试套件必须验证移动端视口（375x667）下代码块支持横向滚动
- **FR-017**: E2E测试套件必须验证移动端导航栏正常显示且高度适中
- **FR-018**: E2E测试套件必须验证平板视口（768x1024）下侧边栏可见或可以展开
- **FR-019**: E2E测试套件必须配置在桌面Chrome浏览器上运行测试
- **FR-020**: E2E测试套件必须配置在移动Chrome浏览器（Pixel 5模拟）上运行测试
- **FR-021**: E2E测试套件必须在测试运行前自动启动文档站开发服务器（pnpm dev）
- **FR-022**: E2E测试套件必须等待开发服务器就绪后再运行测试
- **FR-023**: E2E测试套件必须在CI环境中使用单个worker串行运行测试
- **FR-024**: E2E测试套件必须在CI环境中失败时最多重试2次
- **FR-025**: E2E测试套件必须在测试失败时自动截图和录制视频
- **FR-026**: 所有E2E测试必须清理旧的过时测试用例，移除已经不适用于新文档站的测试代码
- **FR-027**: 所有E2E测试的选择器必须更新以匹配rspress框架生成的实际DOM结构
- **FR-028**: 所有E2E测试必须验证的内容必须与当前文档站的实际内容保持一致

### Key Entities *(include if feature involves data)*

- **测试套件**: 包含所有E2E测试用例的集合，按用户场景分组
- **测试用例**: 单个测试场景的实现，包含Given-When-Then步骤
- **页面对象**: 代表文档站的各个页面（首页、指南页、API页、更新日志页），包含页面URL和关键元素选择器
- **浏览器配置**: 测试运行的浏览器环境（桌面Chrome、移动Chrome）和视口尺寸
- **测试报告**: 测试运行结果，包括通过/失败状态、截图、视频和错误信息

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 所有E2E测试在本地开发环境和CI环境中100%通过，无失败用例
- **SC-002**: E2E测试套件能够在2分钟内完成开发服务器启动和所有测试用例执行
- **SC-003**: 桌面Chrome和移动Chrome两个测试项目的测试用例全部通过
- **SC-004**: 每个核心页面（共10个页面）都有对应的测试用例验证其可访问性和内容正确性
- **SC-005**: 导航功能测试覆盖所有顶部导航链接和至少8个侧边栏链接的跳转验证
- **SC-006**: 代码示例功能测试验证至少2个页面的代码块渲染和复制功能
- **SC-007**: 响应式设计测试覆盖3种视口尺寸（手机、小屏手机、平板）的布局验证
- **SC-008**: 测试失败时自动生成截图和视频，方便开发者快速定位问题
- **SC-009**: 测试代码清晰易读，每个测试用例都有明确的注释说明测试场景和验证点
- **SC-010**: 移除所有与新文档站不匹配的旧测试代码，代码库中不存在过时的测试用例

## Assumptions

- 文档站使用rspress框架构建，生成的DOM结构遵循rspress的默认规范
- 文档站的开发服务器默认运行在 `http://localhost:3000`
- 文档站的所有页面路径和内容与rspress.config.ts中的配置一致
- 测试环境支持Playwright所需的浏览器（Chromium）
- 测试环境的浏览器支持clipboard API（用于测试复制功能）
- CI环境变量通过 `process.env.CI` 检测
- 文档站的静态资源（logo、图片）已正确配置并可访问
- 代码块的语法高亮和行号功能由rspress自动提供
- 侧边栏的展开/收起行为由rspress框架自动处理
- 更新日志页面的内容结构遵循Markdown格式规范

## Dependencies

- Playwright测试框架已安装并正确配置
- 文档站项目的依赖包已完整安装（通过 `pnpm install`）
- 文档站的构建配置（rspress.config.ts）已完成且正确
- 所有文档内容文件（Markdown文件）已更新并包含正确的frontmatter和内容
- 测试环境的Node.js版本满足项目要求（18+ LTS）
- pnpm包管理器已安装并可用

## Out of Scope

- 搜索功能测试（rspress的搜索功能依赖内置搜索，本次重构聚焦核心文档页面）
- 文档站的SEO验证（meta标签、sitemap等）
- 文档站的性能测试（加载时间、Lighthouse评分等）
- 文档站的可访问性测试（WCAG标准、屏幕阅读器兼容性等）
- 多语言切换测试（当前文档站为中文单语言）
- 暗黑模式切换测试（如果文档站未实现暗黑模式）
- 打印样式测试
- API文档的数据准确性验证（测试仅验证页面结构和基本内容，不验证API参数的准确性）
- 占位符API文档的测试（如基金数据、财务数据等尚未实现的API）
- 实时数据API的测试（配置中标注为占位符）
- GitHub外部链接的可用性测试
- 文档内容的拼写和语法检查
- 文档内容的技术准确性审查
