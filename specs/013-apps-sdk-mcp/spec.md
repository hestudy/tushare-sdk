# Feature Specification: Tushare MCP 服务器应用

**Feature Branch**: `013-apps-sdk-mcp`
**Created**: 2025-10-14
**Status**: Draft
**Input**: User description: "在apps文件夹下增加基于sdk的mcp应用,让大模型可以使用mcp获取tushare的数据进行金融分析"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - AI 模型查询实时股票行情数据 (Priority: P1)

AI 助手(如 Claude Desktop)需要帮助用户分析某只股票的最新行情。用户向 AI 提问"帮我看看贵州茅台今天的股价表现",AI 通过 MCP 协议调用 Tushare 服务获取实时行情数据,并向用户展示分析结果。

**Why this priority**: 这是最核心的功能场景,实现了 AI 模型与金融数据源的基本连接。没有这个功能,其他高级分析都无法进行。这是 MVP 的基础。

**Independent Test**: 可以独立测试 - 配置 Claude Desktop 连接 MCP 服务器后,向 AI 询问任意股票代码的行情数据,验证能否成功返回最新价格、涨跌幅等信息。

**Acceptance Scenarios**:

1. **Given** MCP 服务器已启动且 AI 客户端已连接, **When** 用户询问"查询股票 600519 的最新行情", **Then** AI 收到包含股票代码、最新价、涨跌幅、成交量等关键字段的结构化数据
2. **Given** MCP 服务器已配置有效的 Tushare Token, **When** AI 发起行情查询请求, **Then** 服务器成功调用 SDK 并在 5 秒内返回响应
3. **Given** 用户请求查询不存在的股票代码, **When** AI 发起查询, **Then** 返回明确的错误提示"股票代码不存在"

---

### User Story 2 - AI 模型分析公司财务数据 (Priority: P2)

投资者想了解某公司的财务健康状况。用户问 AI"分析一下比亚迪最近三年的盈利能力",AI 通过 MCP 获取该公司的利润表数据(营收、净利润、毛利率等),并生成财务分析报告。

**Why this priority**: 财务分析是专业投资决策的重要依据,但该功能依赖于 P1 的基础数据获取能力。作为增强功能,可以在基础行情查询稳定后独立开发和测试。

**Independent Test**: 可以独立测试 - 向 AI 请求分析指定公司的财务报表,验证能否返回利润表、资产负债表、现金流量表等数据,并确认数据的完整性和准确性。

**Acceptance Scenarios**:

1. **Given** MCP 服务器支持财务数据查询, **When** 用户请求"获取贵州茅台 2021-2023 年的利润表", **Then** 返回三年的营业收入、净利润、毛利率等关键财务指标
2. **Given** 用户请求的财务报告期尚未披露, **When** AI 发起查询, **Then** 返回"该报告期数据暂未披露"的提示
3. **Given** AI 需要对比多家公司财务数据, **When** 批量请求多个公司的财务数据, **Then** 每个请求独立处理,部分失败不影响其他请求

---

### User Story 3 - AI 模型获取历史 K 线数据进行技术分析 (Priority: P3)

技术分析师希望 AI 帮助识别股票的技术形态。用户询问"茅台股票最近 3 个月是上升趋势还是下降趋势",AI 通过 MCP 获取日 K 线数据,分析价格走势和成交量变化,给出技术分析结论。

**Why this priority**: 技术分析是投资策略的补充工具,但不是所有用户的核心需求。该功能可以在基础数据查询(P1)和财务分析(P2)都稳定后作为高级功能独立开发。

**Independent Test**: 可以独立测试 - 请求指定股票在某个时间范围的日/周/月 K 线数据,验证返回的开高低收价格、成交量数据的准确性和完整性。

**Acceptance Scenarios**:

1. **Given** MCP 服务器支持历史 K 线数据查询, **When** 用户请求"获取 600519 最近 90 天的日 K 线", **Then** 返回包含日期、开盘价、最高价、最低价、收盘价、成交量的时间序列数据
2. **Given** 用户请求的时间范围超过数据源限制(如超过 10 年), **When** AI 发起查询, **Then** 返回错误提示"时间范围超出限制,最多支持 X 年历史数据"
3. **Given** 用户请求周 K 线或月 K 线数据, **When** AI 指定不同的时间粒度参数, **Then** 返回对应粒度的聚合数据

---

### User Story 4 - AI 模型查询行业和市场指数数据 (Priority: P4)

宏观分析师需要了解整体市场走势。用户问"今天 A 股市场整体表现如何",AI 通过 MCP 获取上证指数、深证成指、创业板指等主要市场指数的行情数据,并分析市场情绪。

**Why this priority**: 市场指数数据是宏观分析的基础,但相对于个股查询(P1),使用频率较低。作为独立功能,可以在个股数据查询稳定后增量开发。

**Independent Test**: 可以独立测试 - 请求主要市场指数(如 000001.SH 上证指数)的实时行情,验证能否返回指数点位、涨跌幅、成交额等数据。

**Acceptance Scenarios**:

1. **Given** MCP 服务器支持指数数据查询, **When** 用户请求"获取上证指数今日行情", **Then** 返回指数代码、最新点位、涨跌幅、成交额等数据
2. **Given** 用户需要对比多个市场表现, **When** AI 同时查询沪深 300、上证 50、创业板指, **Then** 返回所有请求指数的数据
3. **Given** 市场休市时段, **When** AI 查询指数行情, **Then** 返回最近一个交易日的收盘数据并标注"非交易时段"

---

### Edge Cases

- **Tushare Token 无效或过期时**: 用户未配置 Token 或 Token 过期,MCP 服务器应返回清晰的错误提示"Tushare Token 无效,请检查配置",而不是返回空数据或崩溃
- **API 调用积分不足**: 当用户的 Tushare 积分不足以调用某些高级接口时,返回"接口权限不足,需要更高积分"的提示,并建议用户升级账户或选择其他接口
- **网络请求超时或 Tushare 服务不可用**: 当网络故障或 Tushare API 服务中断时,MCP 服务器应在超时后返回"数据服务暂时不可用,请稍后重试",而不是无限等待
- **AI 客户端并发请求过多**: 当 AI 在短时间内发起大量数据请求(如批量查询 100 只股票)时,MCP 服务器应实施请求限流,避免触发 Tushare 的频率限制导致封禁
- **请求参数格式错误**: 当 AI 传递的股票代码格式不正确(如缺少市场后缀)时,返回"股票代码格式错误,示例: 600519.SH"的提示
- **数据返回为空**: 某些冷门股票或特定时间段可能没有数据,应明确告知"该时间段无交易数据"而不是返回空结果
- **MCP 协议版本兼容性**: AI 客户端使用的 MCP 协议版本与服务器不兼容时,应在初始连接阶段返回版本不匹配的错误

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须作为标准 MCP 服务器运行,支持通过 stdio 传输协议与 AI 客户端(如 Claude Desktop、VSCode 等)通信
- **FR-002**: 系统必须基于 `@hestudy/tushare-sdk` 实现所有 Tushare 数据查询功能,不得直接调用 Tushare HTTP API
- **FR-003**: 系统必须提供工具(Tool)让 AI 查询实时股票行情数据,包括但不限于:股票代码、最新价、涨跌幅、成交量、成交额
- **FR-004**: 系统必须提供工具让 AI 查询公司财务数据,包括利润表、资产负债表、现金流量表的关键指标
- **FR-005**: 系统必须提供工具让 AI 查询历史 K 线数据(日线、周线、月线),包括开高低收价格和成交量
- **FR-006**: 系统必须提供工具让 AI 查询市场指数数据(如上证指数、深证成指等)
- **FR-007**: 系统必须支持从环境变量或配置文件读取 Tushare API Token,不得在代码中硬编码
- **FR-008**: 系统必须对所有 Tushare API 错误(如 Token 无效、积分不足、请求超时)进行捕获,并返回用户友好的错误消息
- **FR-009**: 系统必须在 MCP 工具描述中清晰说明每个工具的用途、必填参数和可选参数,以便 AI 正确调用
- **FR-010**: 系统必须对 AI 的请求参数进行验证(如股票代码格式、日期范围合法性),拒绝无效请求并返回错误说明
- **FR-011**: 系统必须实现基础的请求限流机制,避免 AI 短时间内发起过多请求触发 Tushare 频率限制
- **FR-012**: 系统必须记录关键操作日志(如请求的工具名称、参数、成功/失败状态),便于调试和监控
- **FR-013**: 系统必须支持优雅关闭,当收到 SIGINT 或 SIGTERM 信号时,清理资源并退出

### Key Entities *(include if feature involves data)*

- **MCP Tool**: 代表一个可供 AI 调用的功能单元,包含工具名称、描述、输入参数 Schema 和执行逻辑。每个 Tool 对应一类 Tushare 数据查询(如查询行情、查询财务、查询 K 线)
- **Tushare Query Request**: 代表 AI 发起的数据查询请求,包含查询类型、股票代码、时间范围、其他过滤条件等参数
- **Tushare Query Response**: 代表从 Tushare 获取的数据结果,包含结构化数据(如表格、列表)或错误信息
- **Server Configuration**: 代表 MCP 服务器的运行配置,包含 Tushare Token、日志级别、限流阈值等设置

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: AI 客户端能够在 3 步以内完成 MCP 服务器的配置和连接(安装依赖、配置 Token、启动服务)
- **SC-002**: 对于常见的股票行情查询请求,系统能够在 5 秒内返回结果(包括 Tushare API 调用耗时)
- **SC-003**: 系统能够同时处理至少 5 个并发的 AI 数据请求而不出现超时或错误
- **SC-004**: 当 Tushare Token 无效或积分不足时,错误消息能够明确指出问题原因,用户无需查看日志即可理解
- **SC-005**: AI 模型能够通过自然语言交互成功完成至少 90% 的常见金融数据查询任务(如查询股价、财务数据、K 线数据)
- **SC-006**: 系统启动失败(如缺少配置文件)时,能够在 3 秒内返回清晰的错误提示,而不是静默失败
- **SC-007**: 开发者能够在 10 分钟内根据文档完成从安装到首次成功查询的完整流程

## Scope & Boundaries *(mandatory)*

### In Scope

- 实现标准 MCP 服务器,支持 stdio 传输协议
- 基于 `@hestudy/tushare-sdk` 封装核心金融数据查询功能为 MCP Tools
- 提供配置管理(环境变量/配置文件)和错误处理
- 提供基础的请求限流和日志记录
- 编写用户文档和快速开始指南

### Out of Scope

- **不支持实时 WebSocket 推送**: 本功能仅支持请求-响应模式,不支持实时行情推送(需要独立的流式数据服务)
- **不提供数据缓存**: 每次查询都直接调用 Tushare API,不实现本地缓存机制(缓存策略由未来版本考虑)
- **不支持自定义数据源**: 仅支持 Tushare 数据源,不支持接入其他金融数据 API(如 Yahoo Finance、Bloomberg 等)
- **不提供 Web 管理界面**: 所有配置通过配置文件或环境变量管理,不提供图形化管理界面
- **不实现高级金融算法**: 仅提供原始数据查询能力,不内置技术指标计算(如 MACD、RSI)或量化策略回测
- **不处理 AI 对话逻辑**: 仅负责数据获取,不处理对话上下文、多轮对话或意图识别(由 AI 客户端负责)

## Assumptions & Dependencies *(mandatory)*

### Assumptions

- 用户已拥有有效的 Tushare API Token,并有足够积分调用所需接口
- AI 客户端(如 Claude Desktop)支持 MCP 协议并能正确解析工具定义
- 用户的网络环境能够正常访问 Tushare API 服务(无防火墙阻断)
- 用户基本了解股票代码格式(如需要市场后缀 .SH/.SZ)
- Node.js 运行环境版本 >= 18 LTS

### Dependencies

- **内部依赖**: `@hestudy/tushare-sdk` (本地 workspace 依赖)
- **外部服务**: Tushare Pro API 服务的可用性和稳定性
- **MCP SDK**: 需要使用官方或社区提供的 MCP Server SDK(如 `@modelcontextprotocol/sdk`)
- **运行环境**: Node.js 18+ LTS,支持 ES Modules
- **AI 客户端**: 需要用户安装并配置支持 MCP 的 AI 客户端(如 Claude Desktop、Cline VSCode 扩展等)

## Non-Functional Requirements *(optional)*

### Performance

- 单个数据查询请求的响应时间不超过 5 秒(P95)
- 系统启动时间不超过 3 秒
- 内存占用不超过 200MB(在空闲状态下)

### Reliability

- 当 Tushare API 返回错误时,系统不应崩溃,必须捕获并返回错误消息
- 当网络请求超时(默认 30 秒)后,必须返回超时错误,而不是无限等待

### Usability

- 错误消息必须是面向用户的自然语言描述,而不是技术堆栈信息
- 配置文件格式应简单直观(推荐 JSON 或 .env 格式)
- 提供详细的 README 文档,包含安装、配置、使用示例

### Security

- Tushare Token 必须通过环境变量或加密配置文件提供,不得硬编码在代码中
- 不得将用户的 Token 记录到日志文件中
- 对外暴露的错误消息不得包含敏感信息(如 Token 内容、内部路径等)

## Open Questions *(optional)*

暂无开放问题。所有关键设计决策已基于 MCP 协议标准和 Tushare SDK 现有能力做出合理假设。
