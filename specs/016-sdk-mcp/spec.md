# Feature Specification: MCP 服务补充 SDK 未集成功能

**Feature Branch**: `016-sdk-mcp`
**Created**: 2025-10-14
**Status**: Draft
**Input**: User description: "将sdk中尚未集成至mcp的功能进行补充完整"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 查询股票基本信息 (Priority: P1)

作为 AI 助手的用户,我希望能够通过自然语言查询股票的基本信息(如股票名称、上市日期、所属行业等),以便快速了解一只股票的基本面情况,而不需要手动访问金融网站或使用复杂的 API。

**Why this priority**: 这是最基础的功能,用户在进行任何股票分析之前首先需要了解股票的基本信息。没有这个功能,用户无法获取股票列表、验证股票代码是否有效,或了解股票的基本属性。这是所有其他股票查询的前置依赖。

**Independent Test**: 用户可以通过询问"查询贵州茅台的基本信息"或"600519.SH 是什么股票",系统返回包含股票名称、上市日期、所属行业等基本信息,即可独立验证此功能。

**Acceptance Scenarios**:

1. **Given** 用户想要查询特定股票的基本信息, **When** 用户提供有效的股票代码(如 600519.SH), **Then** 系统返回该股票的名称、上市日期、所属行业、所属市场等基本信息
2. **Given** 用户想要查找股票代码, **When** 用户提供股票名称(如"贵州茅台"), **Then** 系统返回该股票的完整代码和基本信息
3. **Given** 用户想要浏览股票列表, **When** 用户请求查询某个市场(上交所/深交所)或行业的股票列表, **Then** 系统返回符合条件的股票列表,包含代码和名称
4. **Given** 用户提供了无效的股票代码, **When** 系统查询该代码, **Then** 系统提示"未找到该股票信息,请检查股票代码是否正确"

---

### User Story 2 - 查询交易日历信息 (Priority: P2)

作为 AI 助手的用户,我希望能够查询某个日期是否为交易日,或者查询某个时间段内的所有交易日,以便在进行股票数据分析时避免查询非交易日数据,节省时间并提高数据查询的准确性。

**Why this priority**: 这个功能可以帮助用户避免查询非交易日(周末、节假日)的行情数据,提高查询效率。虽然不是最核心的功能,但对提升用户体验很重要,可以避免用户遇到"未找到数据"的错误。

**Independent Test**: 用户可以通过询问"2025年10月14日是交易日吗"或"查询2025年10月的所有交易日",系统返回明确的交易日判断或交易日列表,即可独立验证此功能。

**Acceptance Scenarios**:

1. **Given** 用户想要验证某个日期是否为交易日, **When** 用户提供日期(如 2025-10-14), **Then** 系统返回该日期是否为交易日,以及该日期的相关信息(开盘/休市)
2. **Given** 用户想要查询某个时间段的交易日, **When** 用户提供起止日期(如 2025-10-01 至 2025-10-31), **Then** 系统返回该时间段内所有交易日的列表
3. **Given** 用户查询的日期为节假日, **When** 系统查询该日期, **Then** 系统明确提示"该日期为休市日,休市原因:[节假日名称]"
4. **Given** 用户查询的日期范围超过 1 年, **When** 系统处理该请求, **Then** 系统提示"时间范围超出限制,最多支持查询 1 年的交易日历"

---

### User Story 3 - 查询每日技术指标 (Priority: P3)

作为 AI 助手的用户,我希望能够查询股票的每日技术指标(如市盈率、市净率、换手率、流通市值等),以便进行技术分析和估值判断,辅助投资决策。

**Why this priority**: 这个功能提供更深入的技术分析数据,但相对于基本信息查询和行情查询,它是更高级的需求。用户可以先使用现有的行情查询功能,再通过此功能获取补充的技术指标。

**Independent Test**: 用户可以通过询问"查询贵州茅台今天的市盈率和市净率"或"600519.SH 在 2025-10-14 的换手率是多少",系统返回包含 PE、PB、换手率等技术指标,即可独立验证此功能。

**Acceptance Scenarios**:

1. **Given** 用户想要查询某只股票某日的技术指标, **When** 用户提供股票代码和日期(如 600519.SH, 2025-10-14), **Then** 系统返回该股票当日的市盈率、市净率、换手率、流通市值等技术指标
2. **Given** 用户想要查询某只股票近期的技术指标变化, **When** 用户提供股票代码和日期范围, **Then** 系统返回该时间段内的技术指标数据,便于分析趋势
3. **Given** 用户查询的日期为非交易日, **When** 系统处理该请求, **Then** 系统提示"该日期为非交易日,无技术指标数据,最近交易日为:[日期]"
4. **Given** 某些技术指标不可用(如新股无市盈率), **When** 系统返回数据, **Then** 系统对不可用字段显示"N/A",并在说明中注明原因

---

### Edge Cases

- 当查询的股票代码格式错误(如缺少市场后缀)时,系统如何提示用户正确格式?
- 当查询已退市股票的基本信息时,系统如何标识其状态?
- 当查询的交易日历日期范围跨越多年时,系统如何限制并提示合理的查询范围?
- 当 Tushare API 返回空数据(数据未披露或接口限流)时,系统如何区分原因并给出明确提示?
- 当用户查询的技术指标在某些特殊情况下不存在(如新股无历史 PE)时,系统如何处理?
- 当用户在非交易时间查询"今天"的数据时,系统如何智能判断应返回最近交易日数据?

## Requirements *(mandatory)*

### Functional Requirements

#### 股票基本信息查询 (FR-SB-001 ~ 005)

- **FR-SB-001**: 系统必须支持通过股票代码查询股票基本信息,包括但不限于:股票代码、股票名称、所属行业、所属市场(主板/创业板/科创板)、上市日期、退市日期(如适用)
- **FR-SB-002**: 系统必须支持按市场(上交所/深交所)筛选股票列表
- **FR-SB-003**: 系统必须支持按上市状态筛选股票(上市中/已退市)
- **FR-SB-004**: 系统必须验证输入的股票代码格式,格式为"6位数字.市场后缀"(如 600519.SH, 000001.SZ)
- **FR-SB-005**: 当查询不存在的股票代码时,系统必须返回明确的错误提示:"未找到该股票信息,请检查股票代码是否正确"

#### 交易日历查询 (FR-TC-001 ~ 006)

- **FR-TC-001**: 系统必须支持查询指定日期是否为交易日,返回明确的是/否判断
- **FR-TC-002**: 系统必须支持查询指定日期范围内的所有交易日列表
- **FR-TC-003**: 系统必须在返回非交易日时说明休市原因(周末/节假日/其他)
- **FR-TC-004**: 系统必须验证日期格式为 YYYYMMDD(如 20251014)
- **FR-TC-005**: 系统必须限制交易日历查询范围最多为 1 年,超出时提示用户缩小范围
- **FR-TC-006**: 系统必须支持查询沪深两市的交易日历(两市交易日历相同)

#### 每日技术指标查询 (FR-DB-001 ~ 006)

- **FR-DB-001**: 系统必须支持查询指定股票指定日期的技术指标,包括但不限于:市盈率(PE)、市净率(PB)、总市值、流通市值、换手率
- **FR-DB-002**: 系统必须支持查询指定股票指定日期范围的技术指标数据
- **FR-DB-003**: 当某些技术指标不可用时(如新股无 PE),系统必须显示"N/A"并说明原因
- **FR-DB-004**: 系统必须验证股票代码格式与日期格式的正确性
- **FR-DB-005**: 系统必须在用户查询非交易日数据时,提示"该日期为非交易日,最近交易日为:[日期]"
- **FR-DB-006**: 系统必须限制技术指标查询范围最多为 3 个月,超出时提示用户分批查询

#### 通用要求 (FR-GEN-001 ~ 004)

- **FR-GEN-001**: 所有新增功能必须遵循现有 MCP 工具的错误处理模式,使用统一的错误处理函数
- **FR-GEN-002**: 所有新增功能必须记录日志,包括请求参数、响应状态、错误信息
- **FR-GEN-003**: 所有新增功能必须返回结构化数据和格式化文本两种形式
- **FR-GEN-004**: 所有新增功能必须使用环境变量中的 Tushare Token 进行 API 调用

### Key Entities

- **股票基本信息(StockBasic)**: 表示一只股票的基本属性,包含股票代码、名称、所属行业、上市日期、上市状态等关键属性。与行情数据、财务数据、技术指标通过股票代码关联。

- **交易日历(TradeCalendar)**: 表示市场的交易日信息,包含日期、是否交易日、休市原因等属性。用于判断某个日期是否可以查询行情数据。

- **每日技术指标(DailyBasic)**: 表示股票某个交易日的技术指标,包含市盈率、市净率、总市值、流通市值、换手率等计算指标。通过股票代码和交易日期与股票基本信息和行情数据关联。

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 用户可以通过自然语言查询任意股票的基本信息,系统在 2 秒内返回结果,准确率 100%
- **SC-002**: 用户可以在 3 秒内获取任意日期的交易日判断或 1 年内的交易日列表
- **SC-003**: 用户可以在 3 秒内获取任意股票任意交易日的技术指标数据
- **SC-004**: 当查询非交易日或不存在的股票时,系统能够提供明确、易懂的错误提示,95% 的用户无需进一步求助即可理解并修正查询
- **SC-005**: 所有新增功能的日志记录完整,便于问题排查,错误定位时间减少 50%
- **SC-006**: 新增功能与现有 MCP 工具保持一致的交互体验,用户无需学习新的使用方式

## Assumptions

1. **数据源假设**: 假设 Tushare SDK 的 `getStockBasic`、`getTradeCalendar`、`getDailyBasic` 接口稳定可用,返回数据格式符合官方文档
2. **Token 权限假设**: 假设用户提供的 Tushare Token 具有访问这三个接口的权限(基础权限即可,无需高级权限)
3. **数据更新频率**: 假设股票基本信息变更不频繁(月级别),交易日历在年初发布,每日技术指标在交易日收盘后更新
4. **日期范围限制**: 为避免 API 限流和响应超时,假设单次查询交易日历不超过 1 年,技术指标不超过 3 个月,这是基于 Tushare API 的通用最佳实践
5. **用户环境**: 假设用户已正确配置 MCP 服务的环境变量(TUSHARE_TOKEN),已有其他 MCP 工具的使用经验
6. **错误处理**: 假设复用现有的 `handleTushareError` 错误处理函数,无需为新功能创建新的错误处理逻辑

## Dependencies

- **技术依赖**:
  - 依赖 `@hestudy/tushare-sdk` 包提供的 `getStockBasic`、`getTradeCalendar`、`getDailyBasic` 方法
  - 依赖现有的 MCP 基础设施(server、config、logger、error-handler)

- **数据依赖**:
  - 依赖 Tushare 数据源的可用性和数据质量
  - 依赖用户提供有效的 Tushare Token

- **功能依赖**:
  - 这三个功能相互独立,可以单独开发和测试
  - 但在实际使用中,交易日历功能可以被其他功能调用,用于智能处理非交易日查询

## Out of Scope

以下内容不在本功能范围内,但可能在未来版本中考虑:

1. **数据缓存**: 不实现本地数据缓存机制,每次查询都调用 Tushare API(缓存可在后续优化中添加)
2. **批量查询**: 不支持一次查询多只股票的基本信息或技术指标(用户可多次调用)
3. **高级筛选**: 不支持复杂的股票筛选条件(如按 PE 范围、市值范围筛选),仅支持基础的市场和状态筛选
4. **数据可视化**: 不提供图表展示功能,仅返回文本和结构化数据
5. **历史数据对比**: 不提供多个时间点的数据对比功能(如对比两个季度的 PE 变化)
6. **自定义指标计算**: 不支持基于原始数据计算自定义技术指标
7. **实时数据推送**: 不支持订阅和推送机制,仅支持主动查询
