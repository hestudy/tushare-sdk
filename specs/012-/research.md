# Research Report: 财务数据文档

**Feature Branch**: `012-` | **Date**: 2025-10-13 | **Spec**: [spec.md](./spec.md)

## 研究目标

本研究旨在为文档站中的财务数据文档(特别是现金流量表)提供必要的技术背景和实现指南,确保文档内容准确、完整、易用。

## 1. 现金流量表核心概念

### 1.1 现金流量表定义

现金流量表(Cash Flow Statement)是反映企业在一定会计期间现金和现金等价物流入和流出的财务报表。它将现金流量分为三大活动:

1. **经营活动现金流** - 企业主营业务产生的现金流入和流出
2. **投资活动现金流** - 长期资产的购建及其他投资活动产生的现金流
3. **筹资活动现金流** - 融资活动引起的现金流入和流出

### 1.2 现金流量表的业务价值

- **评估企业盈利质量**: 通过对比净利润和经营活动现金流,判断利润的含金量
- **分析偿债能力**: 现金流量是偿还债务的根本保障
- **预测企业成长性**: 投资活动现金流反映企业的扩张和资本支出
- **判断财务风险**: 筹资活动现金流反映企业的融资需求和资金压力

### 1.3 关键指标说明

基于 Tushare SDK 模型定义 (`packages/tushare-sdk/src/models/financial.ts`),现金流量表包含 87 个字段:

#### 经营活动现金流(核心字段)
- `n_cashflow_act` - 经营活动产生的现金流量净额(最核心指标)
- `c_fr_sale_sg` - 销售商品、提供劳务收到的现金
- `c_paid_goods_s` - 购买商品、接受劳务支付的现金
- `c_paid_to_for_empl` - 支付给职工以及为职工支付的现金
- `c_paid_for_taxes` - 支付的各项税费

#### 投资活动现金流(核心字段)
- `n_cashflow_inv_act` - 投资活动产生的现金流量净额
- `c_pay_acq_const_fiolta` - 购建固定资产、无形资产和其他长期资产支付的现金
- `c_paid_invest` - 投资支付的现金
- `c_recp_return_invest` - 取得投资收益收到的现金

#### 筹资活动现金流(核心字段)
- `n_cash_flows_fnc_act` - 筹资活动产生的现金流量净额
- `c_recp_borrow` - 取得借款收到的现金
- `c_prepay_amt_borr` - 偿还债务支付的现金
- `c_pay_dist_dpcp_int_exp` - 分配股利、利润或偿付利息支付的现金

#### 汇总指标
- `n_incr_cash_cash_equ` - 现金及现金等价物净增加额
- `c_cash_equ_beg_period` - 期初现金及现金等价物余额
- `c_cash_equ_end_period` - 期末现金及现金等价物余额

## 2. SDK 实现分析

### 2.1 API 实现状态

查看 `packages/tushare-sdk/src/api/financial.ts` 确认:
- ✅ `getIncomeStatement` - 利润表 API 已实现
- ✅ `getBalanceSheet` - 资产负债表 API 已实现
- ✅ `getCashFlow` - 现金流量表 API 已实现

### 2.2 数据模型定义

SDK 中的 `CashFlowItem` 接口完整定义了 87 个字段,包括:
- 8 个基本标识字段(股票代码、报告期、公司类型等)
- 16 个经营活动现金流字段
- 9 个投资活动现金流字段
- 8 个筹资活动现金流字段
- 7 个现金汇总指标
- 39 个补充项目字段

### 2.3 查询参数

`FinancialQueryParams` 接口定义了通用查询参数:
- `ts_code` - 股票代码(如 `000001.SZ`)
- `period` - 报告期(YYYYMMDD 格式,优先级最高)
- `start_date` / `end_date` - 报告期区间
- `ann_date` - 公告日期
- `report_type` - 报表类型(1-合并报表, 2-单季合并, 3-调整单季, 4-调整合并)
- `comp_type` - 公司类型

## 3. 现有文档结构分析

### 3.1 利润表文档结构

查看 `apps/docs/docs/api/finance/income.md` 的结构:
1. **标题和描述** - frontmatter + 简短说明
2. **函数签名** - TypeScript 签名和类型
3. **参数表格** - 5 列(参数名、类型、必填、描述、示例)
4. **返回值说明** - 类型 + 94 个字段的详细列表
5. **代码示例** - 3 个实际场景示例
6. **异常说明** - 常见错误类型
7. **注意事项** - 重要提示和最佳实践
8. **相关 API** - 链接到其他相关文档

### 3.2 文档风格规范

- **语言**: 中文
- **代码**: TypeScript,使用 `@tushare/sdk` 导入路径
- **金额单位**: 元(需要在文档中明确说明)
- **日期格式**: YYYYMMDD(需要在文档中明确说明)
- **示例数据**: 使用真实股票代码(如 `000001.SZ`, `600519.SH`)和近期有效报告期
- **注释风格**: 清晰、简洁,关注业务含义

## 4. 演示应用参考

### 4.1 财务数据示例代码

查看 `apps/node-demo/src/examples/financial-data.ts`:
- ✅ 完整的三大报表查询示例
- ✅ 财务指标计算示例(净利率、流动比率、资产负债率等)
- ✅ 综合财务分析示例(健康度评分)
- ✅ 多期对比分析示例(趋势分析)

### 4.2 可复用的代码模式

文档示例可以参考以下模式:
1. **基础查询** - 单股票、单报告期查询
2. **区间查询** - 使用 `start_date` 和 `end_date` 查询多期数据
3. **指标计算** - 基于原始数据计算财务比率
4. **多期对比** - 并行查询多个报告期并计算增长率

## 5. 文档测试策略

### 5.1 E2E 测试(文档可访问性)

测试工具: Playwright

测试用例设计:
1. **导航测试** - 从文档首页导航到财务数据章节,验证链接可访问
2. **页面渲染测试** - 验证三大报表文档页面能正常加载
3. **代码块高亮测试** - 验证代码示例正确渲染和高亮
4. **表格渲染测试** - 验证参数表格和字段表格正确显示

测试文件位置: `tests/e2e/docs/finance-navigation.spec.ts`

### 5.2 内容验证测试(文档质量)

测试工具: vitest

测试用例设计:
1. **结构验证** - 验证文档包含必需的章节(参数、返回值、示例等)
2. **参数完整性** - 验证参数表格包含所有必需列
3. **字段完整性** - 验证返回字段列表与 SDK 模型定义一致
4. **代码示例验证** - 验证示例代码语法正确(使用 TypeScript 编译器 API)
5. **链接有效性** - 验证文档内部链接指向有效页面

测试文件位置: `tests/unit/docs/finance-content.spec.ts`

### 5.3 示例代码可执行性验证

验证方法:
1. 从文档中提取代码示例
2. 使用测试环境的 token 替换占位符
3. 执行代码并验证能成功获取数据
4. 验证返回数据结构符合文档说明

注意事项:
- 使用真实但权限受限的测试 token
- 避免在 CI 环境中频繁调用 API(可能触发限流)
- 使用 mock 数据进行结构验证

## 6. 现金流量表文档需求

### 6.1 必需内容

基于 spec.md 中的功能需求:
1. **FR-002** - 基础调用示例(完整可执行)
2. **FR-003** - 参数说明表格(至少 7 个参数)
3. **FR-004** - 返回字段说明表格(87 个字段,重点标注核心字段)
4. **FR-005** - 至少 2 个业务场景示例
5. **FR-006** - 使用真实股票代码和合理时间参数
6. **FR-007** - 说明权限要求和数据时效性
7. **FR-009** - 整体模块介绍

### 6.2 推荐示例场景

基于业务价值和演示代码:
1. **场景 1: 基础查询** - 查询单个公司最新现金流量表
2. **场景 2: 现金流健康度分析** - 分析经营、投资、筹资三大活动现金流的健康度
3. **场景 3: 自由现金流计算** - 计算企业自由现金流(FCF = 经营现金流 - 资本支出)
4. **场景 4: 多期趋势分析** - 查询多个报告期的现金流并分析变化趋势

## 7. 导航配置分析

### 7.1 当前导航状态

查看 `apps/docs/rspress.config.ts`:
- 财务数据导航当前被注释
- 原因可能是文档内容尚未完成或需要验证

### 7.2 导航配置要求

启用财务数据导航需要:
1. **更新 `rspress.config.ts`** - 取消注释财务数据导航配置
2. **更新 `apps/docs/docs/api/finance/_meta.json`** - 配置章节排序和显示名称
3. **确保所有文档页面存在** - income.md, balance.md, cashflow.md

### 7.3 导航最佳实践

- 使用清晰的章节名称(中文)
- 合理排序(按使用频率或逻辑顺序)
- 提供简短的章节描述
- 确保链接路径与文件路径一致

## 8. 数据时效性和权限说明

### 8.1 数据更新频率

基于 Tushare 官方说明:
- 财务数据更新时间: 上市公司公告后 T+1 日更新
- 数据来源: 上市公司定期报告(季报、半年报、年报)
- 报告期: 通常为季度末日期(03-31, 06-30, 09-30, 12-31)

### 8.2 权限要求

基于 SDK 模型注释:
- 财务数据接口需要至少 **2000 积分**
- 未达到积分要求会返回权限不足错误
- 需要在文档中明确说明权限要求

### 8.3 常见错误和处理

需要在文档中说明:
1. **权限不足** - 提示用户升级账户或获取更多积分
2. **股票代码格式错误** - 必须包含交易所后缀(如 `.SZ`, `.SH`)
3. **报告期不存在** - 某些小公司可能缺少部分报告期数据
4. **数据延迟** - 新公告的数据可能需要 1-2 天才能在 API 中可用

## 9. 关键发现和建议

### 9.1 关键发现

1. ✅ SDK 已完整实现三大财务报表 API
2. ✅ 演示应用提供了丰富的使用示例
3. ✅ 利润表和资产负债表文档已存在,结构完善
4. ⚠️ 现金流量表文档尚未创建,需要补充
5. ⚠️ 导航配置被注释,需要启用
6. ✅ 数据模型定义完整,包含 87 个字段

### 9.2 文档编写建议

1. **复用现有结构** - 参考利润表文档的章节组织
2. **重点标注核心字段** - 87 个字段较多,需要标注重点
3. **提供业务场景示例** - 不仅展示 API 调用,更要体现业务价值
4. **说明字段业务含义** - 避免使用过于技术化的描述
5. **明确数据单位** - 所有金额字段单位为"元"
6. **强调权限要求** - 避免用户执行时遇到意外错误

### 9.3 测试优先流程

根据宪法原则 I(测试优先开发):
1. **Phase 0** - 先编写文档测试用例(E2E + 内容验证)
2. **Phase 1** - 基于测试要求编写现金流量表文档
3. **Phase 2** - 执行测试并根据失败用例修改文档
4. **Phase 3** - 所有测试通过后,启用导航配置

## 10. 参考资料

### 10.1 内部资料

- SDK 财务数据模型: `packages/tushare-sdk/src/models/financial.ts`
- SDK 财务数据 API: `packages/tushare-sdk/src/api/financial.ts`
- 演示应用示例: `apps/node-demo/src/examples/financial-data.ts`
- 利润表文档: `apps/docs/docs/api/finance/income.md`
- 资产负债表文档: `apps/docs/docs/api/finance/balance.md`

### 10.2 外部资料

- Tushare 官方文档: https://tushare.pro/document/2
- 财务报表基础知识: 会计准则和财务分析相关书籍
- TypeScript 文档: https://www.typescriptlang.org/

---

**研究完成日期**: 2025-10-13
**后续步骤**: 进入 Phase 1 设计阶段,编写 data-model.md 和 contracts
