# Feature Specification: 股市数据定时采集与存储应用

**Feature Branch**: `017-`
**Created**: 2025-10-15
**Status**: Draft
**Input**: User description: "搭建一个用于定时存储相关股市数据的应用,便于后期分析"

## User Scenarios & Testing *(mandatory)*

### User Story 1 - 自动化日线行情数据采集 (Priority: P1)

数据分析师需要每天收盘后自动获取最新的股票日线行情数据(开高低收、成交量等),无需手动操作,确保数据及时性和完整性。

**Why this priority**: 这是最核心的功能,日线行情是股票分析的基础数据,自动化采集可以确保数据连续性和及时性,是后续所有分析工作的前提。

**Independent Test**: 可以通过配置单个定时任务,采集指定日期的日线行情数据,验证数据是否正确存储到本地数据库,并能查询导出。

**Acceptance Scenarios**:

1. **Given** 系统配置了每日17:00采集任务, **When** 到达指定时间, **Then** 系统自动调用数据接口获取当日所有A股日线行情并存储
2. **Given** 系统首次启动且无历史数据, **When** 用户指定起始日期, **Then** 系统自动补齐该日期至今的所有交易日数据
3. **Given** 采集任务执行过程中网络异常, **When** 任务失败, **Then** 系统记录错误日志并在下次调度时自动重试
4. **Given** 已存储的数据, **When** 用户按日期或股票代码查询, **Then** 系统返回对应的历史行情数据

---

### User Story 2 - 交易日历维护 (Priority: P2)

研究人员需要准确的交易日历信息,用于区分交易日和非交易日,避免在非交易日执行数据采集任务或进行错误的时间序列分析。

**Why this priority**: 交易日历是股市数据分析的基础设施,虽然不直接产生分析价值,但对数据完整性和任务调度准确性至关重要。

**Independent Test**: 可以独立测试交易日历的获取和存储,验证系统能正确识别某个日期是否为交易日,并据此调度采集任务。

**Acceptance Scenarios**:

1. **Given** 系统初始化, **When** 首次运行, **Then** 系统自动获取最近3年的交易日历并存储
2. **Given** 存储的交易日历, **When** 用户查询某个日期, **Then** 系统返回该日期是否为交易日以及休市原因(如适用)
3. **Given** 定时采集任务触发, **When** 系统检查当日为非交易日, **Then** 任务自动跳过并记录日志
4. **Given** 跨年度时, **When** 系统检测到缺少下一年度日历, **Then** 自动获取并更新交易日历数据

---

### User Story 3 - 数据存储与查询 (Priority: P1)

数据分析师需要将采集的股市数据持久化存储在本地,并支持按时间范围、股票代码等维度灵活查询导出,便于使用分析工具进行深度研究。

**Why this priority**: 数据存储是应用的核心价值,没有可靠的存储和查询能力,采集的数据无法被有效利用。这是实现"便于后期分析"目标的关键。

**Independent Test**: 可以独立测试数据存储模块,插入测试数据后验证查询功能的准确性和性能,以及数据导出格式的正确性。

**Acceptance Scenarios**:

1. **Given** 采集到新的行情数据, **When** 执行存储操作, **Then** 数据以结构化方式保存到本地数据库,支持去重和更新
2. **Given** 已存储的历史数据, **When** 用户按时间范围查询(如2024-01-01至2024-12-31), **Then** 系统返回该时间段内所有数据
3. **Given** 已存储的历史数据, **When** 用户按股票代码查询(如000001.SZ), **Then** 系统返回该股票的所有历史记录
4. **Given** 查询结果, **When** 用户选择导出格式(CSV/JSON), **Then** 系统生成对应格式的文件供下载或外部工具读取
5. **Given** 数据库文件损坏, **When** 系统启动, **Then** 提示用户数据库异常并提供修复建议

---

### User Story 4 - 任务调度管理 (Priority: P2)

系统管理员需要灵活配置数据采集任务的执行时间、频率和范围,根据实际需求调整采集策略,并能查看任务执行历史和状态。

**Why this priority**: 任务调度管理提供了灵活性和可维护性,虽然不是最小可行产品的必需功能,但对长期运维和适应不同用户需求很重要。

**Independent Test**: 可以独立测试任务调度功能,配置不同的任务参数,验证任务是否按预期时间执行,以及任务状态的正确记录。

**Acceptance Scenarios**:

1. **Given** 初始配置, **When** 用户修改采集时间(如从17:00改为16:30), **Then** 系统下次按新时间执行任务
2. **Given** 多个采集任务, **When** 用户查看任务列表, **Then** 系统展示每个任务的配置、下次执行时间和历史执行记录
3. **Given** 运行中的任务, **When** 用户手动停止任务, **Then** 任务立即中止并记录操作日志
4. **Given** 任务执行历史, **When** 某个任务连续失败3次, **Then** 系统发送告警通知(日志或邮件)

---

### Edge Cases

- **非交易日处理**: 当定时任务在非交易日(周末、节假日)触发时,系统应检查交易日历并跳过数据采集,避免无效请求
- **数据去重**: 当重复采集同一日期的数据时,系统应更新而非重复插入,保持数据唯一性
- **API限流处理**: 当数据源API返回限流错误(如每分钟请求超限)时,系统应自动降速或延迟重试
- **历史数据补齐**: 当用户请求补齐大量历史数据时(如5年以上),系统应分批次采集并显示进度,避免超时或内存溢出
- **存储空间不足**: 当磁盘空间不足时,系统应停止数据写入并告警,提示用户清理或扩容
- **时区与交易时间**: 系统应正确处理中国股市交易时间(9:30-15:00),确保采集任务在收盘后执行
- **数据源变更**: 当上游数据接口返回格式变化或服务不可用时,系统应记录详细错误信息便于排查

## Requirements *(mandatory)*

### Functional Requirements

- **FR-001**: 系统必须支持配置定时任务,自动在指定时间(如每日收盘后)采集股票日线行情数据
- **FR-002**: 系统必须能够调用现有数据源接口(tushare-sdk)获取股票行情、交易日历等数据
- **FR-003**: 系统必须将采集的数据持久化存储到本地数据库,支持后续查询和分析
- **FR-004**: 系统必须支持按时间范围(起止日期)查询历史行情数据
- **FR-005**: 系统必须支持按股票代码查询特定股票的历史数据
- **FR-006**: 系统必须支持数据导出功能,至少包含CSV和JSON两种格式
- **FR-007**: 系统必须维护交易日历数据,用于判断交易日和非交易日
- **FR-008**: 系统必须在非交易日自动跳过数据采集任务
- **FR-009**: 系统必须记录每次任务执行的日志,包括执行时间、采集数量、成功/失败状态和错误信息
- **FR-010**: 系统必须支持历史数据补齐功能,允许用户指定起止日期批量采集历史数据
- **FR-011**: 系统必须对已存在的数据进行去重处理,避免重复存储同一日期的相同数据
- **FR-012**: 系统必须在采集失败时自动重试,重试次数和间隔可配置
- **FR-013**: 用户必须能够通过配置文件修改任务调度参数(执行时间、数据范围等)
- **FR-014**: 系统必须提供任务状态查询功能,展示当前任务运行状态和历史执行记录
- **FR-015**: 系统必须在关键错误发生时(如数据库连接失败、API异常)记录详细错误日志

### Key Entities

- **交易日历(Trade Calendar)**: 记录每个日期是否为交易日,包括日期、是否开盘、休市原因等属性,用于任务调度和数据有效性判断
- **日线行情(Daily Quote)**: 股票的每日交易数据,包括股票代码、日期、开盘价、收盘价、最高价、最低价、成交量、成交额等属性
- **采集任务(Collection Task)**: 定义数据采集的配置和调度信息,包括任务名称、执行时间、采集数据类型、目标股票范围等
- **任务执行记录(Task Execution Log)**: 记录每次任务执行的详细信息,包括执行时间、耗时、采集数量、成功/失败状态、错误信息等,用于运维监控
- **股票基础信息(Stock Basic)**: 股票的基本元数据,包括股票代码、名称、所属行业、上市日期等,用于数据查询和筛选

## Success Criteria *(mandatory)*

### Measurable Outcomes

- **SC-001**: 系统能够在每个交易日收盘后30分钟内自动完成当日全市场(4000+只股票)日线行情数据的采集和存储
- **SC-002**: 用户能够在10秒内查询并导出任意时间范围(不超过1年)的单只股票历史数据
- **SC-003**: 系统运行30天后,数据完整率达到99%以上(除去API服务异常导致的缺失)
- **SC-004**: 历史数据补齐功能能够在8小时内完成最近3年全市场的数据回填
- **SC-005**: 系统在遇到临时网络故障或API限流时,能够自动重试并最终成功采集数据,任务成功率达到95%以上
- **SC-006**: 用户能够在5分钟内完成系统初始化配置(数据库初始化、API凭证配置、任务调度设置)并开始首次数据采集
- **SC-007**: 系统能够连续稳定运行30天以上无需人工干预,自动处理非交易日跳过、数据去重等常见场景
- **SC-008**: 数据存储空间效率达到合理水平,1年全市场日线数据存储空间不超过2GB

## Assumptions *(optional)*

### Technical Assumptions

- 用户已经拥有有效的 tushare API 访问凭证(token)
- 系统运行环境为 Node.js 18+ LTS,操作系统为 Linux/macOS/Windows
- 本地存储使用 SQLite 数据库(轻量级、无需额外部署、便于分析工具集成)
- 定时任务调度使用 node-cron 或类似的轻量级调度库
- 数据采集以 A股市场为主,交易时间为工作日 9:30-15:00,收盘后数据可用

### Business Assumptions

- 用户主要需求为中长期数据分析,对实时行情(分钟级、tick级)无强烈需求
- 数据采集频率为每日一次,无需盘中更新
- 用户具备基本的命令行操作能力,能够通过配置文件修改参数
- 系统主要用于个人研究或小团队使用,并发访问需求较低

### Data Assumptions

- 上游数据源(tushare)提供稳定的API服务,单次请求可返回单日全市场数据
- 历史数据补齐时,最远可追溯到2015年(约10年历史),数据量在可接受范围内
- 数据格式遵循 tushare API 的标准返回结构,字段定义稳定

## Dependencies *(optional)*

### Internal Dependencies

- **@hestudy/tushare-sdk**: 核心依赖,用于调用 tushare API 获取股市数据
- 现有的 monorepo 构建工具链(rslib, turborepo)和测试框架(vitest)

### External Dependencies

- **tushare API 服务**: 上游数据提供方,系统依赖其接口可用性和数据质量
- **Node.js 运行时**: 需要 Node.js 18+ LTS 环境
- **本地磁盘存储**: 需要足够的磁盘空间(建议至少10GB可用空间)

## Out of Scope *(optional)*

以下功能明确不在本期特性范围内:

- **实时行情数据**: 不支持分钟级、秒级或 tick 级的实时行情采集
- **数据可视化界面**: 不提供图表展示功能,数据分析由用户使用外部工具完成
- **多用户权限管理**: 不支持多用户、角色权限等企业级功能
- **分布式部署**: 不支持多节点部署、负载均衡等分布式架构
- **数据回测引擎**: 不提供策略回测、技术指标计算等高级分析功能
- **Web UI 管理界面**: 不提供图形化配置和监控界面,配置通过配置文件和命令行完成
- **数据清洗与修正**: 不对上游数据进行复权、除权等二次处理,保持原始数据
- **跨市场数据**: 不支持港股、美股等其他市场数据,仅聚焦 A股市场
- **消息推送与告警**: 不提供邮件、短信、企业微信等主动告警通知功能
- **数据备份与恢复**: 不提供自动备份和灾难恢复机制,用户需自行管理数据库文件
