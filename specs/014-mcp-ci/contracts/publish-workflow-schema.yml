# GitHub Actions Workflow Contract: Multi-Package Publishing
# Feature: 014-mcp-ci
# Date: 2025-10-14

## å·¥ä½œæµå¥‘çº¦è¯´æ˜
# æœ¬æ–‡ä»¶å®šä¹‰äº†å¤šåŒ…å‘å¸ƒå·¥ä½œæµçš„è¾“å…¥è¾“å‡ºå¥‘çº¦,ç¡®ä¿å·¥ä½œæµå„éƒ¨åˆ†çš„æ¥å£æ¸…æ™°ã€‚

---

## è§¦å‘å™¨å¥‘çº¦

trigger:
  event: push
  filters:
    tags:
      - pattern: "(sdk|mcp)-v*"
        description: "æ ‡ç­¾å¿…é¡»ä»¥ sdk-v æˆ– mcp-v å¼€å¤´,åè·Ÿè¯­ä¹‰åŒ–ç‰ˆæœ¬å·"
        examples:
          - "sdk-v1.2.0"
          - "mcp-v0.5.0-beta.1"
          - "sdk-v2.0.0-rc.1"
        invalid_examples:
          - "v1.0.0"  # ç¼ºå°‘åŒ…å‰ç¼€
          - "sdk-1.0.0"  # ç¼ºå°‘ v å‰ç¼€
          - "unknown-v1.0.0"  # æœªçŸ¥çš„åŒ…æ ‡è¯†ç¬¦

---

## Job 1: Detect Package (åŒ…è¯†åˆ«)

description: "ä»æ ‡ç­¾åè§£æåŒ…ä¿¡æ¯,ä¸ºåç»­ job æä¾›å‚æ•°"

inputs:
  github.ref_name:
    type: string
    description: "Git æ ‡ç­¾å,å¦‚ sdk-v1.2.0"
    source: GitHub Actions å†…ç½®å˜é‡

outputs:
  package_id:
    type: string
    description: "åŒ…æ ‡è¯†ç¬¦: sdk æˆ– mcp"
    enum: ["sdk", "mcp"]
    example: "mcp"

  package_name:
    type: string
    description: "npm åŒ…å"
    enum: ["@hestudy/tushare-sdk", "@hestudy/tushare-mcp"]
    example: "@hestudy/tushare-mcp"

  package_path:
    type: string
    description: "åŒ…åœ¨ä»“åº“ä¸­çš„ç›¸å¯¹è·¯å¾„"
    enum: ["packages/tushare-sdk", "apps/tushare-mcp"]
    example: "apps/tushare-mcp"

  version:
    type: string
    description: "è¯­ä¹‰åŒ–ç‰ˆæœ¬å·(å»é™¤ v å‰ç¼€å’ŒåŒ…å‰ç¼€)"
    pattern: "^\\d+\\.\\d+\\.\\d+(-.+)?$"
    example: "1.0.0-beta.1"

validation:
  - rule: "github.ref_name å¿…é¡»åŒ¹é… ^(sdk|mcp)-v\\d+\\.\\d+\\.\\d+(-.+)?$"
    on_failure: "å¿«é€Ÿå¤±è´¥,è¾“å‡ºé”™è¯¯ä¿¡æ¯å¹¶é€€å‡º"
  - rule: "package_id å¿…é¡»æ˜¯ sdk æˆ– mcp"
    on_failure: "å¿«é€Ÿå¤±è´¥"

---

## Job 2: Test and Build (æµ‹è¯•å’Œæ„å»º)

description: "æ‰§è¡Œä»£ç è´¨é‡æ£€æŸ¥ã€æ„å»ºå’Œæµ‹è¯•,ç¡®ä¿ä»£ç å¯å‘å¸ƒ"

dependencies:
  - job: detect-package
    required_outputs: [package_id, package_path]

inputs:
  TUSHARE_TOKEN:
    type: secret
    description: "Tushare API token,ç”¨äºé›†æˆæµ‹è¯•"
    source: GitHub Secrets

steps:
  - name: Lint
    command: pnpm lint
    description: "ä»£ç è§„èŒƒæ£€æŸ¥(workspace çº§åˆ«)"
    on_failure: "ç»ˆæ­¢æµç¨‹"

  - name: Type Check
    command: pnpm type-check
    description: "TypeScript ç±»å‹æ£€æŸ¥(workspace çº§åˆ«)"
    on_failure: "ç»ˆæ­¢æµç¨‹"

  - name: Build
    command: pnpm build
    description: "æ„å»ºæ‰€æœ‰åŒ…(workspace çº§åˆ«)"
    on_failure: "ç»ˆæ­¢æµç¨‹"

  - name: Test with Coverage
    command: pnpm test:coverage
    description: "è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š(workspace çº§åˆ«)"
    on_failure: "ç»ˆæ­¢æµç¨‹"
    env:
      TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}

  - name: Verify Build Artifacts
    description: "éªŒè¯æ„å»ºäº§ç‰©æ˜¯å¦å­˜åœ¨"
    validation:
      - path: "${{ needs.detect-package.outputs.package_path }}/dist"
        must_exist: true
    on_failure: "ç»ˆæ­¢æµç¨‹,è¾“å‡ºé”™è¯¯ä¿¡æ¯"

outputs:
  none

---

## Job 3: Publish to npm (å‘å¸ƒåˆ° npm)

description: "åŒæ­¥ç‰ˆæœ¬å·ã€æ¨æ–­ dist-tagã€æ£€æŸ¥ç‰ˆæœ¬å†²çªã€å‘å¸ƒåˆ° npm"

dependencies:
  - job: detect-package
    required_outputs: [package_id, package_path, package_name, version]
  - job: test-and-build
    must_succeed: true

inputs:
  NPM_AUTOMATION_TOKEN:
    type: secret
    description: "npm è®¤è¯ token"
    source: GitHub Secrets
    scope: "@hestudy/*"

steps:
  - name: Sync Version to package.json
    command: |
      cd ${{ needs.detect-package.outputs.package_path }}
      npm version ${{ needs.detect-package.outputs.version }} --no-git-tag-version --allow-same-version
    description: "å°†æ ‡ç­¾ç‰ˆæœ¬åŒæ­¥åˆ° package.json"
    on_failure: "ç»ˆæ­¢æµç¨‹"

  - name: Verify Version Consistency
    validation:
      - tag_version: "${{ needs.detect-package.outputs.version }}"
        package_json_version:
          path: "${{ needs.detect-package.outputs.package_path }}/package.json"
          field: "version"
        must_match: true
    on_failure: "ç»ˆæ­¢æµç¨‹,è¾“å‡ºä¸ä¸€è‡´çš„ç‰ˆæœ¬å·"

  - name: Infer Dist Tag
    logic: |
      if version contains "-":
        extract prerelease identifier (alpha/beta/rc/next)
        dist_tag = identifier
      else:
        dist_tag = "latest"
    outputs:
      dist_tag:
        type: string
        examples: ["latest", "beta", "alpha", "rc", "next"]

  - name: Check Version Conflict
    command: npm view ${{ needs.detect-package.outputs.package_name }}@${{ needs.detect-package.outputs.version }} version
    expected_result: "command fails (version not found)"
    on_success: "ç»§ç»­å‘å¸ƒ"
    on_failure: "ç»ˆæ­¢æµç¨‹,æç¤ºç‰ˆæœ¬å·²å­˜åœ¨"

  - name: Publish to npm
    command: |
      cd ${{ needs.detect-package.outputs.package_path }}
      pnpm publish --tag ${{ steps.dist-tag.outputs.dist_tag }} --no-git-checks --access public
    env:
      NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTOMATION_TOKEN }}
      NPM_CONFIG_PROVENANCE: true
    description: "å‘å¸ƒåŒ…åˆ° npm,å¯ç”¨ provenance"
    on_failure: "ç»ˆæ­¢æµç¨‹"

  - name: Verify Publication
    command: npm view ${{ needs.detect-package.outputs.package_name }}@${{ needs.detect-package.outputs.version }} version
    expected_result: "version matches tag version"
    description: "éªŒè¯åŒ…æ˜¯å¦æˆåŠŸå‘å¸ƒåˆ° npm(å…è®¸å»¶è¿Ÿ)"
    on_failure: "è®°å½•è­¦å‘Š,ä½†ä¸ç»ˆæ­¢æµç¨‹"

outputs:
  npm_url:
    type: string
    format: "https://www.npmjs.com/package/${{ needs.detect-package.outputs.package_name }}/v/${{ needs.detect-package.outputs.version }}"
    example: "https://www.npmjs.com/package/@hestudy/tushare-mcp/v/1.0.0"

---

## Job 4: Create GitHub Release (åˆ›å»º GitHub Release)

description: "ç”Ÿæˆå˜æ›´æ—¥å¿—å¹¶åˆ›å»º GitHub Release"

dependencies:
  - job: detect-package
    required_outputs: [package_id, version]
  - job: publish
    must_succeed: true

steps:
  - name: Get Previous Tag
    description: "è·å–åŒä¸€åŒ…çš„ä¸Šä¸€ä¸ªå‘å¸ƒæ ‡ç­¾"
    logic: |
      package_id = ${{ needs.detect-package.outputs.package_id }}
      current_tag = ${{ github.ref_name }}

      # åˆ—å‡ºåŒåŒ…çš„æ‰€æœ‰æ ‡ç­¾,æŒ‰ç‰ˆæœ¬å·é™åºæ’åº
      previous_tag = git tag -l "${package_id}-v*" --sort=-version:refname | grep -A1 "$current_tag" | tail -1

      if previous_tag is empty:
        is_first_release = true
    outputs:
      previous_tag:
        type: string
        nullable: true
        example: "mcp-v0.9.0"
      is_first_release:
        type: boolean
        example: false

  - name: Generate Changelog
    description: "ç”Ÿæˆä»ä¸Šä¸€ç‰ˆæœ¬åˆ°å½“å‰ç‰ˆæœ¬çš„å˜æ›´æ—¥å¿—"
    logic: |
      if is_first_release:
        commits = git log --pretty=format:"- %s (%h)" --no-merges
        footer = "**First Release** ğŸ‰"
      else:
        commits = git log $previous_tag..HEAD --pretty=format:"- %s (%h)" --no-merges
        footer = "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$previous_tag...${{ github.ref_name }}"

      changelog = "## What's Changed\n\n" + commits + "\n\n" + footer
    outputs:
      changelog:
        type: string
        format: markdown

  - name: Determine if Prerelease
    logic: |
      version = ${{ needs.detect-package.outputs.version }}
      is_prerelease = version contains "-"
    outputs:
      is_prerelease:
        type: boolean
        example: true

  - name: Create GitHub Release
    uses: actions/create-release@v1
    inputs:
      tag_name: ${{ github.ref_name }}
      release_name: "Release ${{ github.ref_name }}"
      body: ${{ steps.generate-changelog.outputs.changelog }}
      draft: false
      prerelease: ${{ steps.determine-prerelease.outputs.is_prerelease }}
    env:
      GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
    on_failure: "è®°å½•é”™è¯¯,ä½†ä¸å½±å“æ•´ä½“æˆåŠŸ(npm å·²å‘å¸ƒ)"

outputs:
  release_url:
    type: string
    format: "https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
    example: "https://github.com/owner/repo/releases/tag/mcp-v1.0.0"

---

## å¹¶å‘æ§åˆ¶å¥‘çº¦

concurrency:
  group: publish-${{ github.ref }}
  cancel_in_progress: false

behavior:
  - description: "åŒä¸€æ ‡ç­¾çš„å¤šæ¬¡æ¨é€æ’é˜Ÿæ‰§è¡Œ"
    example:
      - time: T1
        tag: "sdk-v1.0.0"
        action: "å¼€å§‹æ‰§è¡Œ"
      - time: T2
        tag: "sdk-v1.0.0"  # é‡å¤æ¨é€
        action: "æ’é˜Ÿç­‰å¾… T1 å®Œæˆ"

  - description: "ä¸åŒæ ‡ç­¾å¹¶è¡Œæ‰§è¡Œ"
    example:
      - time: T1
        tag: "sdk-v1.0.0"
        action: "å¼€å§‹æ‰§è¡Œ"
      - time: T2
        tag: "mcp-v1.0.0"  # ä¸åŒåŒ…
        action: "å¹¶è¡Œæ‰§è¡Œ"

---

## æƒé™å¥‘çº¦

permissions:
  contents: write    # åˆ›å»º GitHub Release
  id-token: write    # npm provenance

---

## é”™è¯¯å¤„ç†å¥‘çº¦

error_handling:
  - stage: "detect-package"
    errors:
      - type: "invalid_tag_format"
        action: "å¿«é€Ÿå¤±è´¥,è¾“å‡ºæ­£ç¡®æ ¼å¼ç¤ºä¾‹"
        exit_code: 1

  - stage: "test-and-build"
    errors:
      - type: "lint_failure"
        action: "ç»ˆæ­¢æµç¨‹,ä¸è¿›å…¥å‘å¸ƒé˜¶æ®µ"
        exit_code: 1
      - type: "test_failure"
        action: "ç»ˆæ­¢æµç¨‹,ä¸è¿›å…¥å‘å¸ƒé˜¶æ®µ"
        exit_code: 1
      - type: "build_artifacts_missing"
        action: "ç»ˆæ­¢æµç¨‹,è¾“å‡ºç¼ºå¤±è·¯å¾„"
        exit_code: 1

  - stage: "publish"
    errors:
      - type: "version_conflict"
        action: "ç»ˆæ­¢æµç¨‹,æç¤ºä½¿ç”¨æ–°ç‰ˆæœ¬å·"
        exit_code: 1
      - type: "npm_publish_failure"
        action: "ç»ˆæ­¢æµç¨‹,ä¸åˆ›å»º GitHub Release"
        exit_code: 1

  - stage: "create-release"
    errors:
      - type: "release_creation_failure"
        action: "è®°å½•è­¦å‘Š,ç»§ç»­æ‰§è¡Œ(npm å·²å‘å¸ƒ)"
        exit_code: 0

---

## æµ‹è¯•åœºæ™¯å¥‘çº¦

test_scenarios:
  - scenario: "å‘å¸ƒç¨³å®šç‰ˆ SDK"
    trigger:
      tag: "sdk-v1.2.0"
    expected:
      package_id: "sdk"
      package_name: "@hestudy/tushare-sdk"
      version: "1.2.0"
      dist_tag: "latest"
      is_prerelease: false

  - scenario: "å‘å¸ƒé¢„å‘å¸ƒç‰ˆ MCP"
    trigger:
      tag: "mcp-v0.5.0-beta.1"
    expected:
      package_id: "mcp"
      package_name: "@hestudy/tushare-mcp"
      version: "0.5.0-beta.1"
      dist_tag: "beta"
      is_prerelease: true

  - scenario: "é¦–æ¬¡å‘å¸ƒ MCP"
    trigger:
      tag: "mcp-v1.0.0"
    precondition:
      previous_tags: []
    expected:
      is_first_release: true
      changelog_contains: "**First Release** ğŸ‰"

  - scenario: "å¹¶å‘å‘å¸ƒä¸åŒåŒ…"
    triggers:
      - tag: "sdk-v1.2.0"
        timestamp: T1
      - tag: "mcp-v1.0.0"
        timestamp: T2
    expected:
      execution: "å¹¶è¡Œ(ä¸åŒ concurrency group)"

  - scenario: "é”™è¯¯æ ‡ç­¾æ ¼å¼"
    trigger:
      tag: "v1.0.0"
    expected:
      result: "å¿«é€Ÿå¤±è´¥"
      error_message: "Invalid tag format. Expected: (sdk|mcp)-v*"

---

## æ€§èƒ½å¥‘çº¦

performance:
  - metric: "æ€»æ‰§è¡Œæ—¶é—´"
    target: "< 15 åˆ†é’Ÿ"
    measurement: "ä»æ ‡ç­¾æ¨é€åˆ° Release åˆ›å»ºå®Œæˆ"

  - metric: "æµ‹è¯•å’Œæ„å»ºæ—¶é—´"
    target: "< 10 åˆ†é’Ÿ"
    measurement: "test-and-build job æ‰§è¡Œæ—¶é—´"

  - metric: "npm å‘å¸ƒæ—¶é—´"
    target: "< 3 åˆ†é’Ÿ"
    measurement: "publish job æ‰§è¡Œæ—¶é—´"

  - metric: "Release åˆ›å»ºæ—¶é—´"
    target: "< 2 åˆ†é’Ÿ"
    measurement: "create-release job æ‰§è¡Œæ—¶é—´"
