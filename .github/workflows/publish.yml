name: Publish to npm

on:
  push:
    tags:
      - 'sdk-v*'  # SDK åŒ…æ ‡ç­¾æ ¼å¼ï¼šsdk-v1.0.0
      - 'mcp-v*'  # MCP åŒ…æ ‡ç­¾æ ¼å¼ï¼šmcp-v1.0.0

# å¹¶å‘æ§åˆ¶ï¼šåŒä¸€æ ‡ç­¾æ’é˜Ÿæ‰§è¡Œï¼Œä¸åŒæ ‡ç­¾å¹¶è¡Œ
concurrency:
  group: publish-${{ github.ref }}
  cancel-in-progress: false

# æƒé™å£°æ˜
permissions:
  contents: write    # åˆ›å»º GitHub Release
  id-token: write    # npm provenance

jobs:
  # Job 0: Detect Package
  # ç›®çš„ï¼šä»æ ‡ç­¾åè§£æåŒ…ä¿¡æ¯ï¼Œä¸ºåç»­ job æä¾›å‚æ•°
  detect-package:
    name: Detect Package
    runs-on: ubuntu-latest
    timeout-minutes: 2
    outputs:
      package_id: ${{ steps.detect.outputs.package_id }}
      package_name: ${{ steps.detect.outputs.package_name }}
      package_path: ${{ steps.detect.outputs.package_path }}
      version: ${{ steps.detect.outputs.version }}

    steps:
      - name: Validate and parse tag
        id: detect
        run: |
          TAG_NAME="${GITHUB_REF_NAME}"
          echo "::notice::Processing tag: $TAG_NAME"

          # éªŒè¯æ ‡ç­¾æ ¼å¼ï¼š(sdk|mcp)-v*
          if [[ ! $TAG_NAME =~ ^(sdk|mcp)-v[0-9]+\.[0-9]+\.[0-9]+(-.+)?$ ]]; then
            echo "::error::Invalid tag format: $TAG_NAME"
            echo "::error::Expected format: (sdk|mcp)-v<semver>"
            echo "::error::Examples: sdk-v1.2.0, mcp-v0.5.0-beta.1"
            exit 1
          fi

          # æå–åŒ…æ ‡è¯†ç¬¦ (sdk æˆ– mcp)
          PACKAGE_ID=$(echo "$TAG_NAME" | sed -E 's/^(sdk|mcp)-.*/\1/')
          echo "package_id=$PACKAGE_ID" >> $GITHUB_OUTPUT
          echo "::notice::Package ID: $PACKAGE_ID"

          # æå–ç‰ˆæœ¬å· (å»é™¤åŒ…å‰ç¼€å’Œ v)
          VERSION=$(echo "$TAG_NAME" | sed -E 's/^(sdk|mcp)-v//')
          echo "version=$VERSION" >> $GITHUB_OUTPUT
          echo "::notice::Version: $VERSION"

          # è®¾ç½®åŒ…åå’Œè·¯å¾„
          if [ "$PACKAGE_ID" = "sdk" ]; then
            PACKAGE_NAME="@hestudy/tushare-sdk"
            PACKAGE_PATH="packages/tushare-sdk"
          elif [ "$PACKAGE_ID" = "mcp" ]; then
            PACKAGE_NAME="@hestudy/tushare-mcp"
            PACKAGE_PATH="apps/tushare-mcp"
          else
            echo "::error::Unknown package ID: $PACKAGE_ID"
            exit 1
          fi

          echo "package_name=$PACKAGE_NAME" >> $GITHUB_OUTPUT
          echo "package_path=$PACKAGE_PATH" >> $GITHUB_OUTPUT
          echo "::notice::Package name: $PACKAGE_NAME"
          echo "::notice::Package path: $PACKAGE_PATH"

  # Job 1: Test & Build
  # ç›®çš„ï¼šç¡®ä¿ä»£ç è´¨é‡ï¼Œåªæœ‰é€šè¿‡æ‰€æœ‰æµ‹è¯•çš„ä»£ç æ‰èƒ½å‘å¸ƒ
  test-and-build:
    name: Test & Build
    runs-on: ubuntu-latest
    needs: detect-package
    timeout-minutes: 10

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
      
      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8
      
      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
      
      - name: Install dependencies
        run: pnpm install --frozen-lockfile
      
      - name: Lint
        run: pnpm lint
      
      - name: Type check
        run: pnpm type-check
      
      - name: Build
        run: pnpm build
      
      - name: Test with coverage
        run: pnpm test:coverage
        env:
          TUSHARE_TOKEN: ${{ secrets.TUSHARE_TOKEN }}
      
      - name: Verify build artifacts
        run: |
          PACKAGE_PATH="${{ needs.detect-package.outputs.package_path }}"
          echo "::group::Verify build artifacts for $PACKAGE_PATH"
          cd "$PACKAGE_PATH"
          if [ ! -d "dist" ]; then
            echo "::error::Build artifacts missing: dist/ directory not found in $PACKAGE_PATH"
            exit 1
          fi
          ls -lh dist/
          echo "::notice::âœ… Build artifacts verified in $PACKAGE_PATH/dist"
          echo "::endgroup::"

  # Job 2: Publish to npm
  # ç›®çš„ï¼šå°†åŒ…å‘å¸ƒåˆ° npmï¼Œè‡ªåŠ¨æ¨æ–­ dist-tag
  publish:
    name: Publish to npm
    runs-on: ubuntu-latest
    needs: [detect-package, test-and-build]
    timeout-minutes: 5

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup pnpm
        uses: pnpm/action-setup@v2
        with:
          version: 8

      - name: Setup Node.js
        uses: actions/setup-node@v4
        with:
          node-version: 20.x
          cache: 'pnpm'
          registry-url: 'https://registry.npmjs.org'

      - name: Install dependencies
        run: pnpm install --frozen-lockfile

      - name: Build
        run: pnpm build

      - name: Sync version to package.json
        run: |
          PACKAGE_PATH="${{ needs.detect-package.outputs.package_path }}"
          VERSION="${{ needs.detect-package.outputs.version }}"
          echo "::group::Sync version from tag to $PACKAGE_PATH"
          cd "$PACKAGE_PATH"
          npm version "$VERSION" --no-git-tag-version --allow-same-version
          echo "::notice::Version synced: $VERSION"
          echo "::endgroup::"
      
      - name: Verify version consistency
        run: |
          PACKAGE_PATH="${{ needs.detect-package.outputs.package_path }}"
          TAG_VERSION="${{ needs.detect-package.outputs.version }}"
          PKG_VERSION=$(node -p "require('./$PACKAGE_PATH/package.json').version")
          echo "Tag version: $TAG_VERSION"
          echo "Package version: $PKG_VERSION"
          if [ "$TAG_VERSION" != "$PKG_VERSION" ]; then
            echo "::error::Version mismatch: tag=$TAG_VERSION, package=$PKG_VERSION"
            exit 1
          fi
          echo "::notice::âœ… Version consistency verified: $TAG_VERSION"
      
      - name: Infer dist-tag
        id: dist-tag
        run: |
          VERSION="${{ needs.detect-package.outputs.version }}"

          # æ¨æ–­ dist-tag
          if [[ $VERSION =~ - ]]; then
            # é¢„å‘å¸ƒç‰ˆæœ¬ï¼šæå–æ ‡è¯†ç¬¦ï¼ˆalpha, beta, rc, nextï¼‰
            PRERELEASE_TAG=$(echo "$VERSION" | sed -E 's/.*-([a-z]+).*/\1/')
            DIST_TAG="$PRERELEASE_TAG"
          else
            # ç¨³å®šç‰ˆæœ¬
            DIST_TAG="latest"
          fi

          echo "dist_tag=$DIST_TAG" >> $GITHUB_OUTPUT
          echo "::notice::Inferred dist-tag: $DIST_TAG (version: $VERSION)"
      
      - name: Check version conflict
        run: |
          PACKAGE_NAME="${{ needs.detect-package.outputs.package_name }}"
          VERSION="${{ needs.detect-package.outputs.version }}"
          if npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null; then
            echo "::error::Version $VERSION already exists on npm for $PACKAGE_NAME. Please use a new version number."
            exit 1
          fi
          echo "::notice::âœ… Version $VERSION is available for $PACKAGE_NAME"

      - name: Publish to npm
        run: |
          PACKAGE_PATH="${{ needs.detect-package.outputs.package_path }}"
          DIST_TAG="${{ steps.dist-tag.outputs.dist_tag }}"
          cd "$PACKAGE_PATH"
          echo "::group::Publishing ${{ needs.detect-package.outputs.package_name }} to npm with tag: $DIST_TAG"
          pnpm publish --tag "$DIST_TAG" --no-git-checks --access public
          echo "::notice::âœ… Published successfully"
          echo "::endgroup::"
        env:
          NODE_AUTH_TOKEN: ${{ secrets.NPM_AUTOMATION_TOKEN }}
          NPM_CONFIG_PROVENANCE: true

      - name: Verify publication
        run: |
          PACKAGE_NAME="${{ needs.detect-package.outputs.package_name }}"
          VERSION="${{ needs.detect-package.outputs.version }}"
          echo "::group::Verify npm publication"
          sleep 5  # ç­‰å¾… npm ç´¢å¼•æ›´æ–°
          PUBLISHED_VERSION=$(npm view "$PACKAGE_NAME@$VERSION" version 2>/dev/null || echo "")
          if [ "$PUBLISHED_VERSION" = "$VERSION" ]; then
            echo "::notice::âœ… Published $PACKAGE_NAME@$VERSION with tag '${{ steps.dist-tag.outputs.dist_tag }}'"
            echo "::notice::ğŸ“¦ npm: https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION"
          else
            echo "::warning::Publication verification failed, but this may be due to npm indexing delay"
          fi
          echo "::endgroup::"

  # Job 3: Create GitHub Release
  # ç›®çš„ï¼šåˆ›å»º GitHub Release å¹¶ç”Ÿæˆå˜æ›´æ—¥å¿—
  create-release:
    name: Create GitHub Release
    runs-on: ubuntu-latest
    needs: [detect-package, publish]
    timeout-minutes: 3

    steps:
      - name: Checkout code
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # è·å–å®Œæ•´å†å²ä»¥ç”Ÿæˆå˜æ›´æ—¥å¿—

      - name: Get previous tag
        id: previous-tag
        run: |
          PACKAGE_ID="${{ needs.detect-package.outputs.package_id }}"
          CURRENT_TAG="${{ github.ref_name }}"

          # è·å–åŒä¸€åŒ…çš„ä¸Šä¸€ä¸ªæ ‡ç­¾
          PREVIOUS_TAG=$(git tag -l "${PACKAGE_ID}-v*" --sort=-version:refname | grep -A1 "$CURRENT_TAG" | tail -1)

          # å¦‚æœç»“æœå’Œå½“å‰æ ‡ç­¾ç›¸åŒ,è¯´æ˜æ²¡æœ‰ä¸Šä¸€ä¸ªæ ‡ç­¾
          if [ "$PREVIOUS_TAG" = "$CURRENT_TAG" ] || [ -z "$PREVIOUS_TAG" ]; then
            PREVIOUS_TAG=""
          fi

          echo "previous_tag=$PREVIOUS_TAG" >> $GITHUB_OUTPUT
          if [ -n "$PREVIOUS_TAG" ]; then
            echo "::notice::Previous tag for $PACKAGE_ID: $PREVIOUS_TAG"
          else
            echo "::notice::No previous tag found for $PACKAGE_ID (first release)"
          fi
      
      - name: Generate changelog
        id: changelog
        run: |
          PREVIOUS_TAG=${{ steps.previous-tag.outputs.previous_tag }}
          
          # ç”Ÿæˆå˜æ›´æ—¥å¿—
          echo "## What's Changed" > changelog.md
          echo "" >> changelog.md
          
          if [ -n "$PREVIOUS_TAG" ]; then
            # æå–è‡ªä¸Šæ¬¡å‘å¸ƒä»¥æ¥çš„ commits
            git log $PREVIOUS_TAG..HEAD --pretty=format:"- %s (%h)" --no-merges >> changelog.md
            echo "" >> changelog.md
            echo "" >> changelog.md
            echo "**Full Changelog**: https://github.com/${{ github.repository }}/compare/$PREVIOUS_TAG...${{ github.ref_name }}" >> changelog.md
          else
            # é¦–æ¬¡å‘å¸ƒ
            git log --pretty=format:"- %s (%h)" --no-merges >> changelog.md
            echo "" >> changelog.md
            echo "" >> changelog.md
            echo "**First Release** ğŸ‰" >> changelog.md
          fi
          
          # è¾“å‡ºå˜æ›´æ—¥å¿—å†…å®¹
          echo "::group::Generated Changelog"
          cat changelog.md
          echo "::endgroup::"
          
          # å°†å˜æ›´æ—¥å¿—ä¿å­˜ä¸ºè¾“å‡ºï¼ˆå¤„ç†å¤šè¡Œï¼‰
          {
            echo 'content<<EOF'
            cat changelog.md
            echo EOF
          } >> $GITHUB_OUTPUT
      
      - name: Determine if prerelease
        id: prerelease
        run: |
          VERSION="${{ needs.detect-package.outputs.version }}"
          if [[ $VERSION =~ - ]]; then
            echo "is_prerelease=true" >> $GITHUB_OUTPUT
            echo "::notice::This is a prerelease version ($VERSION)"
          else
            echo "is_prerelease=false" >> $GITHUB_OUTPUT
            echo "::notice::This is a stable release ($VERSION)"
          fi
      
      - name: Create GitHub Release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name }}
          release_name: Release ${{ github.ref_name }}
          body: ${{ steps.changelog.outputs.content }}
          draft: false
          prerelease: ${{ steps.prerelease.outputs.is_prerelease }}
      
      - name: Report success
        run: |
          PACKAGE_NAME="${{ needs.detect-package.outputs.package_name }}"
          VERSION="${{ needs.detect-package.outputs.version }}"
          echo "::notice::ğŸ‰ Release ${{ github.ref_name }} created successfully"
          echo "::notice::ğŸ“¦ npm: https://www.npmjs.com/package/$PACKAGE_NAME/v/$VERSION"
          echo "::notice::ğŸ“‹ Release: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name }}"
