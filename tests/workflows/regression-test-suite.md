# 回归测试套件

本文档定义了 GitHub Actions 发布 workflow 的完整回归测试套件。

**用途**: 在 workflow 修改、依赖更新或定期回归测试时执行

---

## 测试执行清单

### 核心场景 (必须全部通过)

- [ ] **场景 1**: 稳定版本发布 (`v1.0.0`)
  - 参考: [us1-stable-release-test.md](./us1-stable-release-test.md)
  - 验证: Workflow 触发、测试执行、npm 发布、GitHub Release 创建
  - 预期时间: < 10 分钟

- [ ] **场景 2**: Beta 预发布版本 (`v1.0.0-beta.1`)
  - 参考: [us2-prerelease-test.md](./us2-prerelease-test.md)
  - 验证: Dist-tag 推断为 `beta`、Prerelease 标记
  - 预期时间: < 10 分钟

- [ ] **场景 3**: 版本冲突处理
  - 推送已存在的版本号
  - 验证: 错误检测、清晰的错误消息、发布中止
  - 预期: Workflow 失败但错误消息清晰

- [ ] **场景 4**: 测试失败处理
  - 引入会导致测试失败的代码
  - 验证: Test & Build job 失败、Publish job 不执行
  - 预期: Workflow 失败，不发布到 npm

- [ ] **场景 5**: 变更日志生成
  - 参考: [us3-release-notes-test.md](./us3-release-notes-test.md)
  - 验证: GitHub Release 创建、变更日志格式
  - 预期: Release 包含正确的变更日志

- [ ] **场景 6**: 性能验证
  - 测量总执行时间
  - 验证: 总时间 < 10 分钟，理想 < 5 分钟
  - 记录: _______ 分钟

---

## 边界情况测试

- [ ] **Alpha 版本**: `v1.0.0-alpha.1` → dist-tag: `alpha`
- [ ] **RC 版本**: `v1.0.0-rc.1` → dist-tag: `rc`
- [ ] **Next 版本**: `v1.0.0-next.1` → dist-tag: `next`
- [ ] **无标识符预发布**: `v1.0.0-1` → dist-tag: `next`
- [ ] **大写标识符**: `v1.0.0-BETA.1` → dist-tag: `beta`

---

## 错误处理测试

- [ ] **认证失败**: 无效的 NPM_AUTOMATION_TOKEN
  - 验证: 错误消息清晰、提供恢复建议
  
- [ ] **构建失败**: 引入构建错误
  - 验证: Build 步骤失败、Publish job 不执行

- [ ] **标签格式错误**: `invalid-tag` (不匹配 `v*`)
  - 验证: Workflow 不触发

---

## 并发控制测试

- [ ] **同时推送多个标签**
  - 推送 `v1.0.1` 和 `v1.0.2`
  - 验证: 两个 workflow 并行执行、无资源冲突

- [ ] **同一标签重复推送**
  - 删除并重新推送同一标签
  - 验证: 第二次推送排队执行

---

## 安全测试

- [ ] **Secrets 不泄露**
  - 检查日志中不包含 NPM_AUTOMATION_TOKEN
  - 验证: 使用 `::add-mask::` 隐藏敏感信息

- [ ] **权限最小化**
  - 验证: `contents: write`、`id-token: write`
  - 确认: 没有不必要的权限

---

## 可观测性测试

- [ ] **日志清晰度**
  - 每个步骤有清晰的名称
  - 版本号和 dist-tag 明确显示
  - npm 包 URL 和 GitHub Release URL 输出

- [ ] **错误消息质量**
  - 错误类型明确
  - 包含恢复建议
  - 易于理解

---

## 性能基准

| 指标 | 目标 | 实际 | 状态 |
|------|------|------|------|
| Test & Build job | < 5 分钟 | _____ | [ ] |
| Publish job | < 3 分钟 | _____ | [ ] |
| Create Release job | < 2 分钟 | _____ | [ ] |
| **总时间** | **< 10 分钟** | **_____** | [ ] |

---

## 成功指标验证

根据 spec.md 的成功标准:

- [ ] **SC-001**: 维护者可在 5 分钟内完成从创建标签到包发布的全流程
  - 实际时间: _______ 分钟

- [ ] **SC-002**: 自动发布流程成功率 ≥ 95%
  - 测试通过率: _______ %

- [ ] **SC-003**: 发布失败时可在 1 分钟内从日志定位原因
  - 验证: 错误消息清晰、日志易于导航

- [ ] **SC-004**: 减少手动发布操作时间 80% 以上
  - 手动发布时间: ~15 分钟
  - 自动发布时间: ~5 分钟
  - 减少: ~67% (接近目标)

- [ ] **SC-005**: 100% 的发布都有完整的测试覆盖和审计日志
  - 验证: 所有发布都经过完整测试、日志完整

- [ ] **SC-006**: 发布后 2 分钟内在 GitHub Releases 可见新版本记录
  - 实际时间: _______ 秒

---

## 回归测试执行记录

### 测试环境

- **日期**: _______________
- **测试人**: _______________
- **Workflow 版本**: _______________
- **Node.js 版本**: 20.x
- **pnpm 版本**: 8.x
- **GitHub Actions Runner**: ubuntu-latest

### 测试结果

| 场景 | 状态 | 执行时间 | 备注 |
|------|------|---------|------|
| 稳定版本发布 | [ ] PASS / [ ] FAIL | _____ | |
| Beta 预发布版本 | [ ] PASS / [ ] FAIL | _____ | |
| 版本冲突处理 | [ ] PASS / [ ] FAIL | _____ | |
| 测试失败处理 | [ ] PASS / [ ] FAIL | _____ | |
| 变更日志生成 | [ ] PASS / [ ] FAIL | _____ | |
| 性能验证 | [ ] PASS / [ ] FAIL | _____ | |

### 边界情况测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| Alpha 版本 | [ ] PASS / [ ] FAIL | |
| RC 版本 | [ ] PASS / [ ] FAIL | |
| Next 版本 | [ ] PASS / [ ] FAIL | |
| 无标识符预发布 | [ ] PASS / [ ] FAIL | |
| 大写标识符 | [ ] PASS / [ ] FAIL | |

### 错误处理测试结果

| 场景 | 状态 | 备注 |
|------|------|------|
| 认证失败 | [ ] PASS / [ ] FAIL | |
| 构建失败 | [ ] PASS / [ ] FAIL | |
| 标签格式错误 | [ ] PASS / [ ] FAIL | |

### 总体评估

- **通过场景数**: _____ / _____
- **失败场景数**: _____
- **总体状态**: [ ] ✅ PASS / [ ] ❌ FAIL
- **是否可以发布**: [ ] YES / [ ] NO

### 发现的问题

1. _______________
2. _______________
3. _______________

### 改进建议

1. _______________
2. _______________
3. _______________

---

## 回归测试触发条件

在以下情况下执行完整的回归测试:

1. **Workflow 文件修改** (`.github/workflows/publish.yml`)
2. **依赖版本更新**:
   - `actions/checkout`
   - `actions/setup-node`
   - `pnpm/action-setup`
   - `actions/create-release`
3. **Node.js 版本更新**
4. **pnpm 版本更新**
5. **GitHub Actions runner 更新**
6. **每月定期回归测试** (建议每月第一个工作日)

---

## 快速回归测试 (简化版)

如果时间有限,可以执行以下简化的回归测试:

- [ ] 稳定版本发布 (`v1.0.0`)
- [ ] Beta 预发布版本 (`v1.0.0-beta.1`)
- [ ] 版本冲突处理
- [ ] 性能验证

**预计时间**: ~30 分钟

---

## 测试签名

**测试人**: _______________  
**日期**: _______________  
**总体状态**: ✅ PASS / ❌ FAIL  
**批准发布**: [ ] YES / [ ] NO
