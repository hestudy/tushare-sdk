# Motia è‚¡å¸‚æ•°æ®é‡‡é›†åº”ç”¨

åŸºäº Motia æ¡†æ¶çš„ A è‚¡å¸‚åœºæ•°æ®è‡ªåŠ¨é‡‡é›†ä¸å­˜å‚¨åº”ç”¨,æä¾›å®šæ—¶æ•°æ®é‡‡é›†ã€å†å²æ•°æ®æŸ¥è¯¢å’Œå¯¼å‡ºåŠŸèƒ½ã€‚

## åŠŸèƒ½ç‰¹æ€§

- ğŸ“Š **è‡ªåŠ¨æ•°æ®é‡‡é›†**: å®šæ—¶é‡‡é›† A è‚¡æ—¥çº¿è¡Œæƒ…æ•°æ®(4000+ è‚¡ç¥¨)
- ğŸ“… **äº¤æ˜“æ—¥å†ç»´æŠ¤**: è‡ªåŠ¨ç®¡ç†äº¤æ˜“æ—¥å†,æ™ºèƒ½è·³è¿‡éäº¤æ˜“æ—¥
- ğŸ’¾ **æœ¬åœ°æ•°æ®å­˜å‚¨**: ä½¿ç”¨ SQLite å­˜å‚¨å†å²æ•°æ®,æ”¯æŒå¤æ‚æŸ¥è¯¢
- ğŸ“¤ **æ•°æ®å¯¼å‡º**: æ”¯æŒ CSV/JSON æ ¼å¼å¯¼å‡º,ä¾¿äºåç»­åˆ†æ
- ğŸ”„ **è‡ªåŠ¨é‡è¯•**: å†…ç½®å®¹é”™å’Œé‡è¯•æœºåˆ¶,åº”å¯¹ API é™æµ
- ğŸ“ˆ **å¯è§†åŒ–ç›‘æ§**: Motia Workbench æä¾›ä»»åŠ¡æ‰§è¡Œç›‘æ§å’Œæ—¥å¿—è¿½è¸ª
- ğŸ” **çµæ´»æŸ¥è¯¢**: æ”¯æŒæŒ‰è‚¡ç¥¨ä»£ç ã€æ—¥æœŸèŒƒå›´ç­‰æ¡ä»¶æŸ¥è¯¢
- ğŸ“‹ **ä»»åŠ¡ç®¡ç†**: æŸ¥è¯¢ä»»åŠ¡æ‰§è¡Œå†å²å’ŒçŠ¶æ€

## æ¶æ„æ¦‚è§ˆ

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                    Motia è‚¡å¸‚æ•°æ®é‡‡é›†åº”ç”¨                        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚  Cron Scheduler  â”‚â”€â”€â”€â”€>â”‚  Event System    â”‚â”€â”€â”€â”€>â”‚   Database   â”‚
â”‚  (å®šæ—¶ä»»åŠ¡)       â”‚     â”‚  (äº‹ä»¶é©±åŠ¨)       â”‚     â”‚   (SQLite)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
        â”‚                         â”‚                         â”‚
        â”‚                         â”‚                         â”‚
        v                         v                         v
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”     â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚ScheduleDaily     â”‚â”€â”€â”€â”€>â”‚CollectDaily      â”‚â”€â”€â”€â”€>â”‚ DailyQuotes  â”‚
â”‚Collection        â”‚     â”‚Quotes            â”‚     â”‚ Table        â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜     â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 â”‚
                                 v
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ CollectTrade     â”‚
                         â”‚ Calendar         â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
                                 â”‚
                                 v
                         â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                         â”‚ TradeCalendar    â”‚
                         â”‚ Table            â”‚
                         â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                        API Layer                                 â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¬â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚ QueryQuotesAPI   â”‚  ExportData     â”‚  ListTasksAPI    â”‚TaskLogs â”‚
â”‚ (æŸ¥è¯¢è¡Œæƒ…)        â”‚  (å¯¼å‡ºæ•°æ®)      â”‚  (ä»»åŠ¡åˆ—è¡¨)       â”‚(æ—¥å¿—)   â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”´â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜

                            â¬‡
                    â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
                    â”‚  Tushare API     â”‚
                    â”‚  (æ•°æ®æº)         â”‚
                    â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

## æ•°æ®æµç¨‹

```
1. å®šæ—¶è§¦å‘ (æ¯æ—¥ 17:00)
   â””â”€> ScheduleDailyCollection (Cron Step)
       â””â”€> emit: data.collection.triggered

2. æ•°æ®é‡‡é›†
   â””â”€> CollectDailyQuotes (Event Step)
       â”œâ”€> æ£€æŸ¥äº¤æ˜“æ—¥å†
       â”œâ”€> è°ƒç”¨ Tushare API
       â”œâ”€> ä¿å­˜åˆ°æ•°æ®åº“ (daily_quotes)
       â””â”€> è®°å½•ä»»åŠ¡æ—¥å¿— (task_logs)

3. äº¤æ˜“æ—¥å†ç»´æŠ¤
   â””â”€> CollectTradeCalendar (Event Step)
       â”œâ”€> è·å–äº¤æ˜“æ—¥å†æ•°æ®
       â””â”€> ä¿å­˜åˆ°æ•°æ®åº“ (trade_calendar)

4. æ•°æ®æŸ¥è¯¢ä¸å¯¼å‡º
   â””â”€> QueryQuotesAPI / ExportData (API Steps)
       â”œâ”€> æŸ¥è¯¢æ•°æ®åº“
       â””â”€> è¿”å›ç»“æœ (JSON/CSV)
```

## å¿«é€Ÿå¼€å§‹

### ç¯å¢ƒè¦æ±‚

- **Node.js**: 18.0+ LTS (æ¨è 18.x æˆ– 20.x)
- **åŒ…ç®¡ç†å™¨**: npm æˆ– pnpm
- **Tushare Token**: æœ‰æ•ˆçš„ Tushare Pro API Token ([å…è´¹æ³¨å†Œ](https://tushare.pro/register))
- **ç£ç›˜ç©ºé—´**: è‡³å°‘ 5GB å¯ç”¨ç©ºé—´(å­˜å‚¨ 3-5 å¹´å†å²æ•°æ®)

### å®‰è£…

```bash
# 1. è¿›å…¥é¡¹ç›®ç›®å½•
cd apps/motia-stock-collector

# 2. å®‰è£…ä¾èµ–
pnpm install

# 3. é…ç½®ç¯å¢ƒå˜é‡
cp .env.example .env
# ç¼–è¾‘ .env æ–‡ä»¶,å¡«å…¥ä½ çš„ TUSHARE_TOKEN
```

### é…ç½®

ç¼–è¾‘ `.env` æ–‡ä»¶:

```env
# Tushare API Token (å¿…å¡«)
TUSHARE_TOKEN=your_32_character_token_here

# æ•°æ®åº“è·¯å¾„ (å¯é€‰)
DATABASE_PATH=./data/stock.db

# æ—¥å¿—çº§åˆ« (å¯é€‰: debug/info/warn/error)
LOG_LEVEL=info

# API é™æµé…ç½® (å¯é€‰)
RATE_LIMIT_CONCURRENT=5
RATE_LIMIT_RETRY_DELAY=60000

# Workbench ç«¯å£ (å¯é€‰)
WORKBENCH_PORT=3000
```

### è¿è¡Œ

```bash
# å¼€å‘æ¨¡å¼(å¯åŠ¨ Workbench å¯è§†åŒ–ç•Œé¢)
pnpm dev

# ç”Ÿäº§æ¨¡å¼(åå°è¿è¡Œ)
pnpm start
```

è®¿é—® Workbench: http://localhost:3000

## é¡¹ç›®ç»“æ„

```
apps/motia-stock-collector/
â”œâ”€â”€ steps/                         # Motia Steps (ä¸šåŠ¡é€»è¾‘)
â”‚   â”œâ”€â”€ schedule-daily-collection.step.ts   # å®šæ—¶è°ƒåº¦
â”‚   â”œâ”€â”€ collect-daily-quotes.step.ts        # è¡Œæƒ…é‡‡é›†
â”‚   â”œâ”€â”€ collect-trade-calendar.step.ts      # æ—¥å†é‡‡é›†
â”‚   â”œâ”€â”€ query-quotes-api.step.ts            # æŸ¥è¯¢æ¥å£
â”‚   â”œâ”€â”€ export-data.step.ts                 # å¯¼å‡ºæ¥å£
â”‚   â”œâ”€â”€ list-tasks-api.step.ts              # ä»»åŠ¡åˆ—è¡¨
â”‚   â””â”€â”€ query-task-logs-api.step.ts         # æ—¥å¿—æŸ¥è¯¢
â”œâ”€â”€ lib/                           # å…±äº«æœåŠ¡å’Œå·¥å…·
â”‚   â”œâ”€â”€ database.ts                # æ•°æ®åº“æ“ä½œ
â”‚   â”œâ”€â”€ tushare-client.ts          # Tushare å®¢æˆ·ç«¯å°è£…
â”‚   â”œâ”€â”€ utils.ts                   # å·¥å…·å‡½æ•°
â”‚   â””â”€â”€ error-handler.ts           # é”™è¯¯å¤„ç†
â”œâ”€â”€ types/                         # TypeScript ç±»å‹å®šä¹‰
â”‚   â””â”€â”€ index.ts                   # æ•°æ®æ¨¡å‹ç±»å‹
â”œâ”€â”€ tests/                         # æµ‹è¯•æ–‡ä»¶
â”‚   â”œâ”€â”€ unit/                      # å•å…ƒæµ‹è¯•
â”‚   â”‚   â”œâ”€â”€ database.test.ts
â”‚   â”‚   â”œâ”€â”€ tushare-client.test.ts
â”‚   â”‚   â””â”€â”€ utils.test.ts
â”‚   â””â”€â”€ integration/               # é›†æˆæµ‹è¯•
â”‚       â”œâ”€â”€ collection-flow.test.ts
â”‚       â”œâ”€â”€ storage-query-flow.test.ts
â”‚       â””â”€â”€ trade-calendar-flow.test.ts
â”œâ”€â”€ data/                          # æ•°æ®ç›®å½•
â”‚   â””â”€â”€ stock.db                   # SQLite æ•°æ®åº“æ–‡ä»¶
â”œâ”€â”€ docs/                          # æ–‡æ¡£ç›®å½•
â”‚   â”œâ”€â”€ deployment.md              # éƒ¨ç½²æ–‡æ¡£
â”‚   â””â”€â”€ operations.md              # è¿ç»´æ‰‹å†Œ
â”œâ”€â”€ motia.config.ts                # Motia é…ç½®
â”œâ”€â”€ tsconfig.json                  # TypeScript é…ç½®
â”œâ”€â”€ vitest.config.ts               # æµ‹è¯•é…ç½®
â”œâ”€â”€ package.json                   # é¡¹ç›®é…ç½®
â””â”€â”€ .env.example                   # ç¯å¢ƒå˜é‡ç¤ºä¾‹
```

## æ ¸å¿ƒ Steps

### Cron Steps (å®šæ—¶ä»»åŠ¡)

- **ScheduleDailyCollection** (`schedule-daily-collection.step.ts`)
  - åŠŸèƒ½: æ¯æ—¥å®šæ—¶è§¦å‘æ•°æ®é‡‡é›†ä»»åŠ¡
  - è°ƒåº¦: å‘¨ä¸€è‡³å‘¨äº” 17:00 æ‰§è¡Œ
  - äº‹ä»¶: è§¦å‘ `data.collection.triggered`

### Event Steps (äº‹ä»¶é©±åŠ¨ä»»åŠ¡)

- **CollectDailyQuotes** (`collect-daily-quotes.step.ts`)
  - åŠŸèƒ½: é‡‡é›†æŒ‡å®šæ—¥æœŸçš„å…¨å¸‚åœºæ—¥çº¿è¡Œæƒ…æ•°æ®
  - è®¢é˜…: `data.collection.triggered`
  - é‡è¯•: 3 æ¬¡,å»¶è¿Ÿ 60 ç§’

- **CollectTradeCalendar** (`collect-trade-calendar.step.ts`)
  - åŠŸèƒ½: é‡‡é›†äº¤æ˜“æ—¥å†æ•°æ®
  - è®¢é˜…: `calendar.update.needed`
  - è‡ªåŠ¨æ£€æµ‹: ç¼ºå¤±å¹´åº¦æ•°æ®æ—¶è§¦å‘

### API Steps (HTTP æ¥å£)

- **QueryQuotesAPI** (`query-quotes-api.step.ts`)
  - è·¯å¾„: `GET /api/quotes`
  - åŠŸèƒ½: æŸ¥è¯¢å†å²è¡Œæƒ…æ•°æ®
  - å‚æ•°: `tsCode`, `startDate`, `endDate`, `limit`

- **ExportData** (`export-data.step.ts`)
  - è·¯å¾„: `GET /api/export`
  - åŠŸèƒ½: å¯¼å‡ºæ•°æ®ä¸º CSV/JSON æ ¼å¼
  - å‚æ•°: `format`, `tsCode`, `startDate`, `endDate`

- **ListTasksAPI** (`list-tasks-api.step.ts`)
  - è·¯å¾„: `GET /api/tasks`
  - åŠŸèƒ½: æŸ¥è¯¢æ‰€æœ‰ä»»åŠ¡é…ç½®å’ŒçŠ¶æ€

- **QueryTaskLogsAPI** (`query-task-logs-api.step.ts`)
  - è·¯å¾„: `GET /api/task-logs`
  - åŠŸèƒ½: æŸ¥è¯¢ä»»åŠ¡æ‰§è¡Œå†å²
  - å‚æ•°: `taskName`, `status`, `startDate`, `endDate`, `limit`

## API æ¥å£

### æŸ¥è¯¢è¡Œæƒ…æ•°æ®

```bash
GET /api/quotes?tsCode=600519.SH&startDate=2024-01-01&endDate=2024-12-31&limit=100
```

**è¯·æ±‚å‚æ•°**:
- `tsCode` (å¯é€‰): è‚¡ç¥¨ä»£ç ,å¦‚ `600519.SH`
- `startDate` (å¯é€‰): å¼€å§‹æ—¥æœŸ,æ ¼å¼ `YYYY-MM-DD`
- `endDate` (å¯é€‰): ç»“æŸæ—¥æœŸ,æ ¼å¼ `YYYY-MM-DD`
- `limit` (å¯é€‰): è¿”å›è®°å½•æ•°,é»˜è®¤ 100

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "data": [
    {
      "ts_code": "600519.SH",
      "trade_date": "2024-01-15",
      "open": 1450.00,
      "high": 1460.00,
      "low": 1445.00,
      "close": 1455.00,
      "vol": 50000,
      "amount": 7250000
    }
  ],
  "count": 1
}
```

### å¯¼å‡ºæ•°æ®

```bash
GET /api/export?format=csv&tsCode=600519.SH&startDate=2024-01-01&endDate=2024-12-31
```

**è¯·æ±‚å‚æ•°**:
- `format` (å¿…å¡«): å¯¼å‡ºæ ¼å¼,`csv` æˆ– `json`
- `tsCode` (å¯é€‰): è‚¡ç¥¨ä»£ç 
- `startDate` (å¯é€‰): å¼€å§‹æ—¥æœŸ
- `endDate` (å¯é€‰): ç»“æŸæ—¥æœŸ

**å“åº”**: æ–‡ä»¶ä¸‹è½½

### æŸ¥è¯¢ä»»åŠ¡åˆ—è¡¨

```bash
GET /api/tasks
```

**å“åº”ç¤ºä¾‹**:
```json
{
  "success": true,
  "tasks": [
    {
      "name": "ScheduleDailyCollection",
      "type": "cron",
      "schedule": "0 17 * * 1-5",
      "nextRun": "2024-01-16T17:00:00Z"
    }
  ]
}
```

### æŸ¥è¯¢ä»»åŠ¡æ—¥å¿—

```bash
GET /api/task-logs?taskName=CollectDailyQuotes&status=SUCCESS&limit=10
```

**è¯·æ±‚å‚æ•°**:
- `taskName` (å¯é€‰): ä»»åŠ¡åç§°
- `status` (å¯é€‰): ä»»åŠ¡çŠ¶æ€,`SUCCESS` æˆ– `FAILED`
- `startDate` (å¯é€‰): å¼€å§‹æ—¥æœŸ
- `endDate` (å¯é€‰): ç»“æŸæ—¥æœŸ
- `limit` (å¯é€‰): è¿”å›è®°å½•æ•°,é»˜è®¤ 100

## æµ‹è¯•

```bash
# è¿è¡Œæ‰€æœ‰æµ‹è¯•
pnpm test

# è¿è¡Œæµ‹è¯•å¹¶ç”Ÿæˆè¦†ç›–ç‡æŠ¥å‘Š
pnpm run test:coverage

# è¿è¡Œå•å…ƒæµ‹è¯•
pnpm run test:unit

# è¿è¡Œé›†æˆæµ‹è¯•
pnpm run test:integration
```

## æ•°æ®åº“ Schema

### trade_calendar (äº¤æ˜“æ—¥å†)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| cal_date | TEXT | æ—¥æœŸ (PRIMARY KEY) |
| exchange | TEXT | äº¤æ˜“æ‰€ä»£ç  |
| is_open | INTEGER | æ˜¯å¦å¼€ç›˜ (0/1) |
| pretrade_date | TEXT | ä¸Šä¸€äº¤æ˜“æ—¥ |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ |

### daily_quotes (æ—¥çº¿è¡Œæƒ…)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INTEGER | ä¸»é”® |
| ts_code | TEXT | è‚¡ç¥¨ä»£ç  |
| trade_date | TEXT | äº¤æ˜“æ—¥æœŸ |
| open | REAL | å¼€ç›˜ä»· |
| high | REAL | æœ€é«˜ä»· |
| low | REAL | æœ€ä½ä»· |
| close | REAL | æ”¶ç›˜ä»· |
| vol | REAL | æˆäº¤é‡ |
| amount | REAL | æˆäº¤é¢ |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ |

### task_logs (ä»»åŠ¡æ—¥å¿—)

| å­—æ®µ | ç±»å‹ | è¯´æ˜ |
|------|------|------|
| id | INTEGER | ä¸»é”® |
| task_name | TEXT | ä»»åŠ¡åç§° |
| start_time | TEXT | å¼€å§‹æ—¶é—´ |
| end_time | TEXT | ç»“æŸæ—¶é—´ |
| status | TEXT | çŠ¶æ€ (SUCCESS/FAILED) |
| records_count | INTEGER | å¤„ç†è®°å½•æ•° |
| error_message | TEXT | é”™è¯¯ä¿¡æ¯ |
| created_at | TEXT | åˆ›å»ºæ—¶é—´ |

## é…ç½®è¯´æ˜

### ç¯å¢ƒå˜é‡

ä¸»è¦ç¯å¢ƒå˜é‡:

- `TUSHARE_TOKEN`: Tushare API Token (å¿…å¡«)
- `DATABASE_PATH`: SQLite æ•°æ®åº“æ–‡ä»¶è·¯å¾„
- `LOG_LEVEL`: æ—¥å¿—çº§åˆ« (debug/info/warn/error)
- `RATE_LIMIT_CONCURRENT`: API å¹¶å‘è¯·æ±‚æ•°é™åˆ¶
- `RATE_LIMIT_RETRY_DELAY`: API é‡è¯•å»¶è¿Ÿ(æ¯«ç§’)
- `WORKBENCH_PORT`: Workbench ç«¯å£

è¯¦è§ `.env.example`

### Motia é…ç½®

`motia.config.ts` æ–‡ä»¶é…ç½® Motia è¿è¡Œæ—¶å‚æ•°:

```typescript
export default {
  runtime: {
    port: process.env.WORKBENCH_PORT || 3000,
  },
  storage: {
    provider: 'sqlite',
    path: process.env.DATABASE_PATH || './data/stock.db',
  },
  logging: {
    level: process.env.LOG_LEVEL || 'info',
  },
};
```

## è¿ç»´æŒ‡å—

### æ•°æ®å¤‡ä»½

```bash
# æ‰‹åŠ¨å¤‡ä»½æ•°æ®åº“
cp ./data/stock.db ./data/backups/stock_$(date +%Y%m%d).db

# å®šæœŸå¤‡ä»½(æ·»åŠ åˆ° crontab)
0 2 * * * cd /path/to/app && cp ./data/stock.db ./data/backups/stock_$(date +\%Y\%m\%d).db
```

### ç›‘æ§

ä½¿ç”¨ Motia Workbench ç›‘æ§:
1. è®¿é—® http://localhost:3000
2. æŸ¥çœ‹ "Traces" æ ‡ç­¾æŸ¥çœ‹ä»»åŠ¡æ‰§è¡Œå†å²
3. æŸ¥çœ‹ "Logs" æ ‡ç­¾æŸ¥çœ‹å®æ—¶æ—¥å¿—
4. æŸ¥çœ‹ "Workflow" æ ‡ç­¾æŸ¥çœ‹ Steps ä¾èµ–å…³ç³»

### å¸¸è§é—®é¢˜

#### 1. Tushare Token æ— æ•ˆ

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `.env` æ–‡ä»¶ä¸­çš„ Token æ˜¯å¦æ­£ç¡®
- ç¡®è®¤ Token æ²¡æœ‰è¿‡æœŸ
- æµ‹è¯• Token æ˜¯å¦å¯ç”¨: `curl -X POST https://api.tushare.pro -d '{"api_name":"trade_cal","token":"your_token"}'`

#### 2. æ•°æ®åº“æ–‡ä»¶æ— æ³•åˆ›å»º

**è§£å†³æ–¹æ¡ˆ**:
- ç¡®ä¿ `data/` ç›®å½•å­˜åœ¨
- æ£€æŸ¥ç£ç›˜ç©ºé—´æ˜¯å¦å……è¶³
- æ£€æŸ¥æ–‡ä»¶æƒé™: `chmod 755 data/`

#### 3. API é™æµé”™è¯¯

**è§£å†³æ–¹æ¡ˆ**:
- æ£€æŸ¥ `RATE_LIMIT_CONCURRENT` é…ç½®æ˜¯å¦åˆç†
- ç¡®è®¤ Tushare è´¦æˆ·ç­‰çº§å’Œé™æµé…é¢
- ç­‰å¾…ä¸€æ®µæ—¶é—´åé‡è¯•

#### 4. é‡‡é›†ä»»åŠ¡å¤±è´¥

**è§£å†³æ–¹æ¡ˆ**:
- æŸ¥çœ‹ Workbench æ—¥å¿—è·å–è¯¦ç»†é”™è¯¯ä¿¡æ¯
- æ£€æŸ¥ç½‘ç»œè¿æ¥æ˜¯å¦æ­£å¸¸
- ç¡®è®¤äº¤æ˜“æ—¥å†æ•°æ®æ˜¯å¦å®Œæ•´
- æŸ¥è¯¢ `task_logs` è¡¨è·å–å¤±è´¥åŸå› 

## æ€§èƒ½ä¼˜åŒ–

### æ•°æ®åº“ä¼˜åŒ–

1. **ç´¢å¼•ä¼˜åŒ–**: å·²åˆ›å»ºç´¢å¼•
   - `idx_quotes_ts_code`: æŒ‰è‚¡ç¥¨ä»£ç æŸ¥è¯¢
   - `idx_quotes_trade_date`: æŒ‰æ—¥æœŸèŒƒå›´æŸ¥è¯¢
   - `idx_calendar_date`: äº¤æ˜“æ—¥å†æŸ¥è¯¢

2. **æ‰¹é‡æ’å…¥**: ä½¿ç”¨äº‹åŠ¡æ‰¹é‡æ’å…¥æ•°æ®,æé«˜å†™å…¥æ€§èƒ½

3. **WAL æ¨¡å¼**: SQLite å¯ç”¨ WAL æ¨¡å¼,æ”¯æŒå¹¶å‘è¯»

### API é™æµä¼˜åŒ–

1. **å¹¶å‘æ§åˆ¶**: ä½¿ç”¨ `p-limit` æ§åˆ¶å¹¶å‘è¯·æ±‚æ•°
2. **é‡è¯•æœºåˆ¶**: Event Steps è‡ªåŠ¨é‡è¯•å¤±è´¥è¯·æ±‚
3. **ç¼“å­˜ç­–ç•¥**: äº¤æ˜“æ—¥å†æ•°æ®ç¼“å­˜,å‡å°‘é‡å¤è¯·æ±‚

## æŠ€æœ¯æ ˆ

- **æ¡†æ¶**: Motia (äº‹ä»¶é©±åŠ¨æ¶æ„)
- **è¯­è¨€**: TypeScript 5.x
- **è¿è¡Œæ—¶**: Node.js 18+ LTS
- **æ•°æ®æº**: Tushare Pro API
- **å­˜å‚¨**: SQLite (better-sqlite3)
- **é™æµ**: p-limit
- **æµ‹è¯•**: Vitest
- **æ„å»º**: TypeScript Compiler

## ç›¸å…³æ–‡æ¡£

- [éƒ¨ç½²æ–‡æ¡£](./docs/deployment.md)
- [è¿ç»´æ‰‹å†Œ](./docs/operations.md)
- [Motia å®˜æ–¹æ–‡æ¡£](https://motia.dev)
- [Tushare Pro æ–‡æ¡£](https://tushare.pro/document/2)
- [é¡¹ç›®è§„èŒƒ](../../specs/017-/)

## å¼€å‘è´¡çŒ®

æ¬¢è¿è´¡çŒ®ä»£ç !è¯·éµå¾ªä»¥ä¸‹è§„èŒƒ:

1. Fork æœ¬ä»“åº“
2. åˆ›å»ºåŠŸèƒ½åˆ†æ”¯: `git checkout -b feature/new-feature`
3. ç¼–å†™æµ‹è¯•å¹¶ç¡®ä¿æµ‹è¯•é€šè¿‡
4. æäº¤ä»£ç : `git commit -m "Add new feature"`
5. æ¨é€åˆ†æ”¯: `git push origin feature/new-feature`
6. åˆ›å»º Pull Request

## License

MIT

## æ›´æ–°æ—¥å¿—

### v1.0.0 (2025-10-15)

- âœ… å®ç°å®šæ—¶æ•°æ®é‡‡é›†åŠŸèƒ½ (US1)
- âœ… å®ç°äº¤æ˜“æ—¥å†ç»´æŠ¤åŠŸèƒ½ (US2)
- âœ… å®ç°æ•°æ®å­˜å‚¨ä¸æŸ¥è¯¢åŠŸèƒ½ (US3)
- âœ… å®ç°ä»»åŠ¡ç®¡ç†åŠŸèƒ½ (US4)
- âœ… å®Œæ•´æµ‹è¯•è¦†ç›–(è¦†ç›–ç‡ â‰¥ 80%)
- âœ… éƒ¨ç½²å’Œè¿ç»´æ–‡æ¡£å®Œå–„
