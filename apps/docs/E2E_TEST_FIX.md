# E2E 测试端口配置修复

## 问题诊断

### 原始问题
E2E 测试在开发服务器启动后卡住,无法继续执行。

### 根本原因
**端口不匹配**:
- rspress 默认使用端口 **3000**
- Playwright 配置期待端口 **5173**
- 导致 Playwright 一直等待 `http://localhost:5173` 响应,但服务器实际运行在 3000

### 证据
```
[WebServer]   ➜ Network:  http://localhost:3000/   ← 实际端口
[WebServer]   ➜ Network:  http://localhost:3001/   ← 端口被占用时自动切换

playwright.config.ts:
url: 'http://localhost:5173',  ← 错误配置,永远等不到!
```

## 解决方案

### 已修复的文件

#### 1. `playwright.config.ts`
```typescript
// 修改前
use: {
  baseURL: 'http://localhost:5173',
}
webServer: {
  url: 'http://localhost:5173',
}

// 修改后
use: {
  baseURL: 'http://localhost:3000',  // ✅ 匹配 rspress 默认端口
}
webServer: {
  url: 'http://localhost:3000',      // ✅ 匹配 rspress 默认端口
}
```

#### 2. `rspress.config.ts`
```typescript
// 添加了注释说明
/**
 * 开发服务器配置
 * 注意: rspress 默认使用端口 3000
 * 如需修改,可通过命令行参数: rspress dev --port 5173
 */
```

#### 3. `scripts/check-dev-server.sh`
更新为检查端口 3000 而不是 5173

## 验证步骤

### 1. 检查端口配置
```bash
./scripts/check-dev-server.sh
```

### 2. 运行 E2E 测试
```bash
pnpm test:e2e
```

### 预期行为
1. Playwright 启动并执行 `pnpm dev`
2. rspress 在端口 3000 启动
3. Playwright 检测到 `http://localhost:3000` 可访问
4. 开始运行测试
5. 测试完成后自动关闭服务器

## 工作流程

```
┌─────────────────────────────────────────────────────────┐
│ 1. 运行 pnpm test:e2e                                   │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 2. Playwright 检查 http://localhost:3000 是否可访问     │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
         ┌───────┴────────┐
         │                │
    不可访问          可访问
         │                │
         ▼                ▼
┌──────────────┐   ┌──────────────┐
│ 3a. 执行     │   │ 3b. 复用     │
│ pnpm dev     │   │ 现有服务器   │
└──────┬───────┘   └──────┬───────┘
       │                  │
       └────────┬─────────┘
                │
                ▼
┌─────────────────────────────────────────────────────────┐
│ 4. 等待服务器就绪 (最多 120 秒)                         │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 5. 运行所有 E2E 测试                                    │
└────────────────┬────────────────────────────────────────┘
                 │
                 ▼
┌─────────────────────────────────────────────────────────┐
│ 6. 测试完成,自动关闭服务器 (CI 环境)                   │
│    或保持运行 (本地开发环境)                            │
└─────────────────────────────────────────────────────────┘
```

## 注意事项

### rspress 端口选择机制
rspress 会自动选择可用端口:
- 首选: 3000
- 如果 3000 被占用: 3001
- 如果 3001 被占用: 3002
- 以此类推...

### Playwright 配置
- `reuseExistingServer: !process.env.CI`
  - **本地开发**: 复用已有服务器,测试后不关闭
  - **CI 环境**: 总是启动新服务器,测试后自动关闭

### 如果需要固定端口
可以修改 `package.json`:
```json
{
  "scripts": {
    "dev": "rspress dev --port 3000"
  }
}
```

## 故障排除

### 问题: 测试仍然超时
**检查**:
1. 端口 3000 是否被其他进程占用
   ```bash
   lsof -i :3000
   ```
2. 服务器是否正常启动
   ```bash
   pnpm dev
   ```

### 问题: 端口冲突
**解决**:
1. 停止占用端口的进程
   ```bash
   lsof -ti :3000 | xargs kill -9
   ```
2. 或使用不同端口
   ```bash
   rspress dev --port 3001
   # 同时更新 playwright.config.ts 中的端口
   ```

## 测试状态

✅ **已修复**: 端口配置已同步
✅ **已验证**: 配置文件已更新
⏳ **待测试**: 需要运行 `pnpm test:e2e` 验证

## 下一步

1. 运行 E2E 测试验证修复
2. 如果测试通过,更新 tasks.md 标记 T086 完成
3. 查看测试报告,修复任何失败的测试用例
